<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>OSLAPRINT | Paco</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --osla-orange: #f37021;
            --osla-dark: #0a0a0a;
            --osla-card: #161616;
        }

        body {
            background-color: var(--osla-dark);
            color: #fff;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding-bottom: 60px;
        }

        .navbar {
            background: #000;
            border-bottom: 2px solid var(--osla-orange);
            padding: 0.8rem 1rem;
        }

        .text-muted {
            color: #d1d1d1 !important;
        }

        .form-label,
        label {
            color: #f8f9fa !important;
            font-weight: 500;
        }

        .nav-link {
            color: #d1d1d1;
            font-weight: 600;
            border: none !important;
            font-size: 0.9rem;
        }

        .nav-link.active {
            color: var(--osla-orange) !important;
            background: transparent !important;
            border-bottom: 3px solid var(--osla-orange) !important;
        }

        .table-dark {
            --bs-table-bg: #161616;
            color: #f1f1f1;
            border-radius: 10px;
            overflow: hidden;
        }

        .card-emp {
            background: var(--osla-card);
            border: 1px solid #333;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .btn-delete-user {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #dc3545;
            background: none;
            border: none;
        }

        #calendarAdmin,
        #calendarGlobal {
            background: #fff;
            color: #000;
            padding: 10px;
            border-radius: 10px;
            min-height: 620px;
        }

        /* Autocomplete Styles */
        .suggestions-list {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: #1f1f1f;
            border: 1px solid #444;
            border-radius: 0 0 8px 8px;
            z-index: 1050;
            display: none;
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            color: #fff;
        }

        .suggestion-item:hover {
            background: var(--osla-orange);
            color: white;
        }

        /* Filtros Calendario Din√°micos - MEJORADO */
        .btn-check:checked+.btn-outline-custom {
            color: white !important;
            background-color: var(--osla-orange) !important;
            border-color: var(--osla-orange) !important;
            border-width: 2px;
            opacity: 1;
            font-weight: 700;
            box-shadow: 0 0 10px rgba(243, 112, 33, 0.5);
        }

        .btn-outline-custom {
            color: #bbb;
            border-color: #555;
            background-color: transparent;
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .btn-outline-custom:hover {
            opacity: 1;
            filter: brightness(1.2);
            background-color: rgba(243, 112, 33, 0.2);
            border-color: var(--osla-orange);
        }

        .filter-group {
            background: #1f1f1f;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #333;
        }

        /* Badge de soporte mejorado para mejor visibilidad */
        .support-badge {
            background-color: #28a745 !important;
            color: white !important;
            font-weight: 700 !important;
            padding: 6px 12px !important;
            font-size: 0.85rem !important;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.4);
            border: 2px solid #20c997 !important;
        }

        .no-support-badge {
            background-color: #dc3545 !important;
            color: white !important;
            font-weight: 700 !important;
            padding: 6px 12px !important;
            font-size: 0.85rem !important;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
            border: 2px solid #c82333 !important;
        }

        /* Mobile overrides */
        @media(max-width: 768px) {
            .nav-tabs {
                display: flex;
                justify-content: space-around;
                flex-wrap: wrap;
            }

            .nav-item {
                flex: 1 1 30%;
                text-align: center;
                font-size: 0.8em;
            }

            .fc-header-toolbar {
                flex-direction: column;
                font-size: 0.8em;
            }
        }

        /* Task List Styles */
        .task-list-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .task-item {
            background: #1f1f1f;
            border-left: 4px solid #444;
            padding: 7px 10px;
            margin-bottom: 6px;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 0.82rem;
            cursor: pointer;
        }

        .task-item:hover {
            background: #2a2a2a;
        }

        .task-item.status-Completado {
            border-left-color: #198754;
            opacity: 0.7;
        }

        .task-item.status-Pendiente {
            border-left-color: var(--osla-orange);
        }
    </style>
</head>

<body>

    <nav class="navbar d-flex justify-content-between sticky-top">
        <span class="fw-bold fs-5 text-white">OSLA<span style="color:var(--osla-orange)">PRINT</span> <small
                class="badge bg-secondary ms-1" style="font-size: 0.6em;">PACO</small></span>
        <div class="d-flex align-items-center gap-2">
            <span class="text-white fw-bold me-2">Hola {{ current_user.username }}</span>
            <button class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#modalChangePassword"
                title="Cambiar Contrase√±a">
                <i class="bi bi-key-fill"></i>
            </button>
            <a href="/logout" class="btn btn-outline-danger btn-sm"><i class="bi bi-power"></i></a>
        </div>
    </nav>

    <div class="container mt-3 pb-5">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div id="flashMessages" style="position:fixed;top:70px;right:20px;z-index:9999;min-width:300px;max-width:450px;">
            {% for category, m in messages %}
            <div class="alert alert-{{ 'success' if category == 'success' else 'danger' if category == 'danger' else 'info' }} py-2 small flash-msg shadow" style="border-radius:10px;">
                <i class="bi bi-{{ 'check-circle-fill' if category == 'success' else 'exclamation-triangle-fill' if category == 'danger' else 'info-circle-fill' }} me-1"></i>
                {{ m }}
                <button type="button" class="btn-close btn-close-sm float-end" onclick="this.parentElement.remove()" style="font-size:0.65rem;"></button>
            </div>
            {% endfor %}
        </div>
        <script>
            // Auto-dismiss success messages after 4 seconds, keep error messages longer
            setTimeout(function() {
                var msgs = document.querySelectorAll('.flash-msg.alert-success');
                msgs.forEach(function(m) {
                    m.style.transition = 'opacity 0.5s';
                    m.style.opacity = '0';
                    setTimeout(function() { if(m.parentElement) m.remove(); }, 500);
                });
            }, 4000);
            setTimeout(function() {
                var msgs = document.querySelectorAll('.flash-msg');
                msgs.forEach(function(m) {
                    m.style.transition = 'opacity 0.5s';
                    m.style.opacity = '0';
                    setTimeout(function() { if(m.parentElement) m.remove(); }, 500);
                });
            }, 9000);
        </script>
        {% endif %}
        {% endwith %}

        <ul class="nav nav-tabs mb-4 border-0 bg-dark sticky-top pt-2" style="top:55px; z-index:900;" role="tablist">
            <li class="nav-item"><button class="nav-link active w-100" data-bs-toggle="tab"
                    data-bs-target="#team">EQUIPO</button></li>
            <li class="nav-item"><button class="nav-link w-100" data-bs-toggle="tab" data-bs-target="#global-agenda"
                    id="tabGlobalBtn">AGENDA GLOBAL</button></li>
            <li class="nav-item"><button class="nav-link w-100" data-bs-toggle="tab"
                    data-bs-target="#data">INFORMES</button></li>
            <li class="nav-item"><button class="nav-link w-100" data-bs-toggle="tab"
                    data-bs-target="#statistics">ESTAD√çSTICAS</button></li>
            <li class="nav-item"><button class="nav-link w-100" data-bs-toggle="tab"
                    data-bs-target="#stock">STOCK</button></li>
            <li class="nav-item"><button class="nav-link w-100" data-bs-toggle="tab"
                    data-bs-target="#clients">CLIENTES</button></li>
            <li class="nav-item"><button class="nav-link w-100" data-bs-toggle="tab"
                    data-bs-target="#pagos" id="tabPagosBtn" onclick="loadPaymentsList()">PAGOS</button></li>
            <li class="nav-item"><button class="nav-link w-100" data-bs-toggle="tab"
                    data-bs-target="#config">CONFIGURACI√ìN</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="team">
                <div class="d-flex justify-content-between mb-3 align-items-center">
                    <h4 class="fw-bold text-white fs-5 m-0">Gesti√≥n de Equipo</h4>
                    <button class="btn btn-warning btn-sm fw-bold" data-bs-toggle="modal"
                        data-bs-target="#modalAddUser">
                        <i class="bi bi-person-plus-fill me-1"></i> Nuevo Usuario
                    </button>
                </div>

                <div class="row g-3">
                    {% for u in empleados %}
                    <div class="col-12 col-sm-6 col-md-4">
                        <div class="card-emp">
                            <button class="btn-delete-user" data-bs-toggle="modal" data-bs-target="#modalDeleteUser"
                                onclick="document.getElementById('deleteUserId').value='{{ u.id }}';">
                                <i class="bi bi-x-circle-fill fs-4"></i>
                            </button>
                            <i class="bi bi-person-circle fs-1 mb-2 text-warning"></i>
                            <h5 class="mb-1 text-white fw-bold">{{ u.username }}</h5>
                            <small class="text-muted">ID: #{{ u.id }}</small>
                            <hr class="my-3" style="border-color:#333;">
                            <button class="btn btn-sm btn-primary w-100 mb-2"
                                onclick="loadEmployeeCalendar({{ u.id }})">
                                <i class="bi bi-calendar-check-fill me-1"></i> Ver Calendario
                            </button>
                            <button class="btn btn-sm btn-outline-info w-100 mb-2" onclick="viewTechStats({{ u.id }})">
                                <i class="bi bi-graph-up me-1"></i> Ver Estad√≠sticas
                            </button>
                            <!-- ‚úÖ NUEVO: Bot√≥n perfil t√©cnico -->
                            <button class="btn btn-sm btn-outline-warning w-100 mb-2" onclick="openTechProfileModal({{ u.id }}, '{{ u.username }}')">
                                <i class="bi bi-person-lines-fill me-1"></i> Ver Perfil
                            </button>
                            <button class="btn btn-sm btn-outline-light w-100" data-bs-toggle="modal" data-bs-target="#modalRenameUser"
                                onclick="openRenameModal({{ u.id }}, '{{ u.username }}')">
                                <i class="bi bi-pencil-fill me-1"></i> Cambiar Nombre
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div id="calendarAdminContainer" class="mt-4" style="display:none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="text-white fw-bold m-0" id="empCalendarTitle">Calendario de Empleado</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="closeEmployeeCalendar()">
                            <i class="bi bi-x-circle me-1"></i> Cerrar
                        </button>
                    </div>
                    <div class="row">
                        <div class="col-lg-9">
                            <div id="calendarAdmin"></div>
                        </div>
                        <div class="col-lg-3">
                            <div class="card bg-dark border-secondary mt-3 mt-lg-0">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0 small"><i class="bi bi-list-task me-2"></i>Lista de Tareas</h6>
                                </div>
                                <div class="card-body p-1">
                                    <div id="adminTaskListContainer" class="task-list-container" style="max-height: 580px; overflow-y: auto;">
                                        <div class="text-center text-muted py-3">Cargando...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="global-agenda">
                <div class="d-flex justify-content-between mb-3 align-items-center flex-wrap gap-2">
                    <h4 class="fw-bold text-white fs-5 m-0">Agenda Global de Tareas</h4>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-info btn-sm fw-bold" onclick="refreshGlobalCalendar()"
                            title="Actualizar calendario">
                            <i class="bi bi-arrow-clockwise me-1"></i> Actualizar
                        </button>
                        <button class="btn btn-warning btn-sm fw-bold" data-bs-toggle="modal"
                            data-bs-target="#modalScheduleAppointment">
                            <i class="bi bi-calendar-plus-fill me-1"></i> Nueva Cita
                        </button>
                        <button class="btn btn-danger btn-sm fw-bold" data-bs-toggle="modal"
                            data-bs-target="#modalCreateUnassignedTask"
                            title="Crear tarea sin t√©cnico asignado">
                            <i class="bi bi-exclamation-circle-fill me-1"></i> Tarea Pendiente
                        </button>
                        <button class="btn btn-info btn-sm fw-bold" data-bs-toggle="modal"
                            data-bs-target="#modalRemoteAssistance"
                            title="Crear asistencia remota">
                            <i class="bi bi-telephone-fill me-1"></i> Asistencia Remota
                        </button>
                    </div>
                </div>

                <!-- FILTROS DIN√ÅMICOS POR TIPO -->
                <div class="filter-group mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted fw-bold">FILTRAR POR TIPO DE SERVICIO</small>
                        <button class="btn btn-outline-light btn-sm" onclick="checkAllFilters()">
                            <i class="bi bi-check-all me-1"></i> Todos
                        </button>
                    </div>
                    <div class="btn-group-sm d-flex flex-wrap gap-2" role="group">
                        {% for svc in all_service_types %}
                        <input type="checkbox" class="btn-check filter-cb" id="filter-{{ svc.id }}"
                            value="{{ svc.name }}" checked onchange="updateGlobalFilters()">
                        <label class="btn btn-outline-custom flex-grow-1" for="filter-{{ svc.id }}"
                            data-color="{{ svc.color }}">
                            {{ svc.name }}
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- LEYENDA DE T√âCNICOS POR COLOR -->
                <div id="techLegend" class="mb-3 p-3 rounded" style="background:#1a1a1a; border:1px solid #333;">
                    <small class="text-muted fw-bold d-block mb-2"><i class="bi bi-person-fill me-1"></i>T√âCNICOS (color en calendario)</small>
                    <div id="techLegendItems" class="d-flex flex-wrap gap-2">
                        <span class="text-muted small">Cargando...</span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-9">
                        <div id="calendarGlobal"></div>
                    </div>
                    <div class="col-lg-3">
                        <div class="card bg-dark border-secondary mt-3 mt-lg-0">
                            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 small"><i class="bi bi-list-task me-2"></i>Tareas</h6>
                                <div class="form-check form-switch mb-0">
                                    <input class="form-check-input" type="checkbox" id="toggleCompletedGlobal" onchange="renderGlobalTaskList()">
                                    <label class="form-check-label" style="font-size:0.75rem;" for="toggleCompletedGlobal">Completadas</label>
                                </div>
                            </div>
                            <div class="card-body p-1">
                                <div id="globalTaskListContainer" class="task-list-container" style="max-height: 580px; overflow-y: auto;">
                                    <div class="text-center text-muted py-3">Cargando...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN: Tareas Pendientes sin Asignar -->
                <div class="card bg-dark border-danger border-2 mt-4">
                    <div class="card-header bg-danger bg-opacity-20 border-danger">
                        <h5 class="card-title text-danger mb-0">
                            <i class="bi bi-exclamation-circle-fill me-2"></i>Tareas Pendientes por Asignar
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="unassignedTasksList" style="max-height: 400px; overflow-y: auto;">
                            <div class="text-muted text-center py-3">
                                <i class="bi bi-inbox me-2"></i>Cargando tareas sin asignar...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="data">
                <h4 class="fw-bold text-white fs-5 mb-3">Informes T√©cnicos Completados</h4>
                
                <!-- Filtros de informes -->
                <div class="card bg-dark border-secondary mb-3">
                    <div class="card-body py-2">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label text-white small mb-1"><i class="bi bi-person me-1"></i>Cliente</label>
                                <input type="text" id="reportFilterClient" class="form-control form-control-sm bg-black text-white border-secondary"
                                    placeholder="Buscar cliente..." oninput="loadReports()">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label text-white small mb-1"><i class="bi bi-calendar me-1"></i>Desde</label>
                                <input type="date" id="reportFilterFrom" class="form-control form-control-sm bg-black text-white border-secondary"
                                    onchange="loadReports()">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label text-white small mb-1"><i class="bi bi-calendar me-1"></i>Hasta</label>
                                <input type="date" id="reportFilterTo" class="form-control form-control-sm bg-black text-white border-secondary"
                                    onchange="loadReports()">
                            </div>
                            <div class="col-md-2 d-flex gap-1">
                                <button class="btn btn-sm btn-outline-warning flex-fill" onclick="loadReports()">
                                    <i class="bi bi-search"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary flex-fill" onclick="clearReportFilters()">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mt-1">
                            <small id="reportResultCount" class="text-muted"></small>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-dark table-sm">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Servicio</th>
                                <th>Fecha</th>
                                <th>T√©cnico</th>
                                <th><i class="bi bi-stopwatch me-1"></i>Tiempo</th>
                                <th>Archivos</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTbody">
                            {% for r in informes %}
                            <tr data-report-id="{{ r.id }}" data-client="{{ r.client_name|lower }}" data-date="{{ r.date.strftime('%Y-%m-%d') }}">
                                <td>{{ r.id }}</td>
                                <td>{{ r.client_name }}</td>
                                <td>{{ r.service_type.name if r.service_type is not string else r.service_type }}</td>
                                <td>{{ r.date.strftime('%d/%m/%Y') }}</td>
                                <td>{{ r.tech.username if r.tech else 'Sin t√©cnico' }}</td>
                                <td>
                                    {% if r.work_duration %}
                                        <span style="font-family:'Courier New',monospace;font-size:0.85rem;font-weight:700;color:#f37021;background:#1a0d00;border:1px solid #f37021;border-radius:6px;padding:3px 8px;letter-spacing:1px;white-space:nowrap;">{{ r.work_duration }}</span>
                                    {% else %}
                                        <span class="text-muted small">‚Äî</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if r.attachments %}
                                    {% set att_list = r.attachments|from_json %}
                                    {% if att_list and att_list|length > 0 %}
                                    <button class="btn btn-sm btn-outline-info" onclick="showAttachmentsModal({{ r.id }}, '{{ r.client_name }}')">
                                        <i class="bi bi-paperclip"></i> {{ att_list|length }}
                                    </button>
                                    {% else %}
                                    <span class="text-muted small">Sin archivos</span>
                                    {% endif %}
                                    {% else %}
                                    <span class="text-muted small">Sin archivos</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="/print_report/{{ r.id }}" target="_blank" class="btn btn-sm btn-outline-warning">
                                        <i class="bi bi-printer-fill"></i> Imprimir
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB ESTAD√çSTICAS -->
            <div class="tab-pane fade" id="statistics">
                <h4 class="fw-bold text-white fs-5 mb-4">
                    <i class="bi bi-graph-up-arrow me-2 text-info"></i>Estad√≠sticas Globales
                </h4>

                <!-- Filtros -->
                <div class="card bg-dark border-secondary mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label text-white fw-bold">T√©cnico</label>
                                <select id="statsFilterTech" class="form-select bg-black text-white border-secondary">
                                    <option value="">Todos los t√©cnicos</option>
                                    {% for emp in empleados %}
                                    <option value="{{ emp.id }}">{{ emp.username }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label text-white fw-bold">Per√≠odo</label>
                                <select id="statsFilterPeriod" class="form-select bg-black text-white border-secondary" onchange="toggleCustomDateFields()">
                                    <option value="all">Todo el historial</option>
                                    <option value="month">√öltimo mes</option>
                                    <option value="week">√öltima semana</option>
                                    <option value="custom">Fecha personalizada</option>
                                </select>
                            </div>
                            <div class="col-md-2" id="customDateFromField" style="display:none;">
                                <label class="form-label text-white fw-bold">Desde</label>
                                <input type="date" id="statsDateFrom" class="form-control bg-black text-white border-secondary">
                            </div>
                            <div class="col-md-2" id="customDateToField" style="display:none;">
                                <label class="form-label text-white fw-bold">Hasta</label>
                                <input type="date" id="statsDateTo" class="form-control bg-black text-white border-secondary">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button class="btn btn-info w-100" onclick="loadAdminStatistics()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Actualizar Estad√≠sticas
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KPIs -->
                <div class="row g-3 mb-4" id="statsKPIs">
                    <div class="col-md-3">
                        <div class="card bg-dark border-info">
                            <div class="card-body text-center">
                                <i class="bi bi-clipboard-check fs-1 text-info"></i>
                                <h3 class="text-white mt-2 mb-0" id="kpiTotalTasks">-</h3>
                                <small class="text-muted">Total Tareas</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-dark border-success">
                            <div class="card-body text-center">
                                <i class="bi bi-check-circle fs-1 text-success"></i>
                                <h3 class="text-white mt-2 mb-0" id="kpiCompletedTasks">-</h3>
                                <small class="text-muted">Completadas</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-dark border-warning">
                            <div class="card-body text-center">
                                <i class="bi bi-hourglass-split fs-1 text-warning"></i>
                                <h3 class="text-white mt-2 mb-0" id="kpiPendingTasks">-</h3>
                                <small class="text-muted">Pendientes</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-dark border-secondary">
                            <div class="card-body text-center">
                                <i class="bi bi-people fs-1 text-secondary"></i>
                                <h3 class="text-white mt-2 mb-0" id="kpiActiveTechs">-</h3>
                                <small class="text-muted">T√©cnicos Activos</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gr√°ficos -->
                <div class="row g-3">
                    <!-- Gr√°fico Circular de Tipos de Tareas -->
                    <div class="col-md-6">
                        <div class="card bg-dark border-secondary">
                            <div class="card-header bg-black border-secondary">
                                <h6 class="text-white fw-bold mb-0">
                                    <i class="bi bi-pie-chart-fill me-2 text-warning"></i>
                                    Distribuci√≥n por Tipo de Servicio
                                </h6>
                            </div>
                            <div class="card-body">
                                <canvas id="taskTypesPieChart" style="max-height: 300px;"></canvas>
                                <div id="noPieData" class="text-center text-muted py-5" style="display: none;">
                                    <i class="bi bi-info-circle fs-1"></i>
                                    <p class="mt-2">No hay datos disponibles</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN ANAL√çTICAS - REMOVIDA -->
            <!-- Las anal√≠ticas ahora se muestran individualmente por t√©cnico desde la tarjeta de cada uno en EQUIPO -->

            <div class="tab-pane fade" id="stock">
                <div class="d-flex justify-content-between mb-3 align-items-center">
                    <h4 class="fw-bold text-white fs-5 m-0">Gesti√≥n de Inventario</h4>
                    <div>
                        <button class="btn btn-outline-info btn-sm fw-bold me-2" onclick="loadStockTree()">
                            <i class="bi bi-arrow-clockwise me-1"></i> Recargar
                        </button>
                        <button class="btn btn-warning btn-sm fw-bold" data-bs-toggle="modal"
                            data-bs-target="#modalAddStock">
                            <i class="bi bi-plus-circle-fill me-1"></i> Nuevo Art√≠culo
                        </button>
                    </div>
                </div>

                <!-- Vista jer√°rquica de categor√≠as y productos -->
                <div id="stockCategoriesTree" class="border border-secondary rounded p-3 bg-black"
                    style="min-height: 300px;">
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-hourglass-split"></i> Cargando inventario...
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="clients">
                <div class="d-flex justify-content-between mb-3 align-items-center flex-wrap gap-2">
                    <h4 class="fw-bold text-white fs-5 m-0">Gesti√≥n de Clientes</h4>
                    <div class="d-flex gap-2">
                        <button class="btn btn-warning btn-sm fw-bold" data-bs-toggle="modal"
                            data-bs-target="#modalAddClient">
                            <i class="bi bi-person-plus-fill me-1"></i> Nuevo Cliente
                        </button>
                        <button class="btn btn-outline-info btn-sm" data-bs-toggle="modal"
                            data-bs-target="#modalImportClients">
                            <i class="bi bi-upload me-1"></i> Importar
                        </button>
                    </div>
                </div>

                <input type="text" id="clientSearchInput" class="form-control mb-3" placeholder="üîç Buscar cliente..."
                    onkeyup="filterClientsView()">

                <div class="row g-3" id="clientsCardContainer">
                    {% for c in clients %}
                    <div class="col-12 col-md-6 col-lg-4 client-card-wrapper" data-client-name="{{ c.name|lower }}"
                        data-client-phone="{{ c.phone }}" data-client-email="{{ c.email }}">
                        <div class="card bg-dark border-secondary text-white h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title text-warning fw-bold mb-0">{{ c.name }}</h6>
                                {% if c.has_support %}
                                    <span class="badge support-badge">
                                        <i class="bi bi-shield-check"></i> Soporte
                                    </span>
                                {% else %}
                                    <span class="badge no-support-badge">
                                        <i class="bi bi-shield-x"></i> Sin Soporte
                                    </span>
                                {% endif %}
                                </div>

                                {% if c.has_support and c.support_schedule %}
                                <div class="mb-1">
                                    {% if c.support_schedule == 'lv' %}
                                    <span class="badge bg-success bg-opacity-25 border border-success text-success" style="font-size:0.72rem;">
                                        <i class="bi bi-clock me-1"></i>L‚ÄìV
                                    </span>
                                    {% elif c.support_schedule == 'ls' %}
                                    <span class="badge bg-warning bg-opacity-25 border border-warning text-warning" style="font-size:0.72rem;">
                                        <i class="bi bi-clock me-1"></i>L‚ÄìS
                                    </span>
                                    {% elif c.support_schedule == 'ld' %}
                                    <span class="badge bg-danger bg-opacity-25 border border-danger text-danger" style="font-size:0.72rem;">
                                        <i class="bi bi-clock me-1"></i>L‚ÄìD
                                    </span>
                                    {% endif %}
                                </div>
                                {% endif %}

                                <hr class="border-secondary my-2">

                                <div class="small mb-1">
                                    <i class="bi bi-telephone-fill text-info me-2"></i>
                                    <a href="tel:{{ c.phone }}" class="text-decoration-none text-white">{{ c.phone
                                        }}</a>
                                </div>

                                <div class="small mb-1">
                                    <i class="bi bi-envelope-fill text-info me-2"></i>
                                    <a href="/cdn-cgi/l/email-protection#fc8787dc9fd299919d9590dc8181"
                                        class="text-decoration-none text-white">{{ c.email }}</a>
                                </div>

                                <div class="small mb-2">
                                    <i class="bi bi-geo-alt-fill text-info me-2"></i>
                                    <span class="text-muted">{{ c.address }}</span>
                                    <a href="https://www.google.com/maps/search/?api=1&query={{ c.address | urlencode }}" target="_blank" class="btn btn-xs btn-outline-warning btn-sm ms-1 py-0 px-1" title="Abrir en Google Maps">
                                        <i class="bi bi-geo-alt-fill" style="font-size:0.75rem;"></i>
                                    </a>
                                </div>

                                {% if c.link %}
                                <div class="mb-2">
                                    <a href="{{ c.link }}" target="_blank" class="btn btn-sm btn-outline-info w-100">
                                        <i class="bi bi-globe me-1"></i>Sitio Web
                                    </a>
                                </div>
                                {% endif %}

                                {% if c.notes %}
                                <div class="small text-muted fst-italic border-top border-secondary pt-2 mt-2">
                                    <i class="bi bi-sticky-fill me-1"></i>{{ c.notes|truncate(60) }}
                                </div>
                                {% endif %}
                                
                                <!-- Horas de trabajo este mes -->
                                <div class="border-top border-secondary pt-2 mt-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted"><i class="bi bi-stopwatch me-1"></i>Horas este mes:</small>
                                        <button class="btn btn-xs btn-outline-info py-0 px-1 ms-1" style="font-size:0.7rem;"
                                            onclick="showClientWorkHours({{ c.id }}, '{{ c.name }}')">
                                            <span id="clientHours_{{ c.id }}">Ver</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="card-footer bg-black border-secondary">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-warning flex-fill edit-client-btn"
                                        data-client-id="{{ c.id }}">
                                        <i class="bi bi-pencil-fill"></i> Editar
                                    </button>
                                    <form method="POST" action="/manage_clients" class="flex-fill">
                                        <input type="hidden" name="action" value="delete">
                                        <input type="hidden" name="client_id" value="{{ c.id }}">
                                        <button class="btn btn-sm btn-outline-danger w-100"
                                            onclick="return confirm('¬øEliminar cliente {{ c.name }}?')">
                                            <i class="bi bi-trash-fill"></i> Eliminar
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    {% if clients|length == 0 %}
                    <div class="col-12">
                        <div class="alert alert-info text-center">
                            <i class="bi bi-info-circle me-2"></i>No hay clientes registrados a√∫n.
                            Haz clic en "Nuevo Cliente" para a√±adir uno.
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>


            <!-- ======================================================= -->
            <!-- PESTA√ëA PAGOS                                            -->
            <!-- ======================================================= -->
            <div class="tab-pane fade" id="pagos">
                <div class="d-flex justify-content-between mb-3 align-items-center flex-wrap gap-2">
                    <h4 class="fw-bold text-white fs-5 m-0">
                        <i class="bi bi-cash-coin me-2 text-warning"></i>Gesti√≥n de Pagos
                    </h4>
                    <span class="text-muted small" id="pagosTotalCount"></span>
                </div>

                <!-- Buscador para a√±adir clientes sin pago -->
                <div class="card bg-dark border-secondary mb-3">
                    <div class="card-body py-2">
                        <div class="d-flex gap-2 align-items-center flex-wrap">
                            <div class="flex-fill position-relative" style="max-width:350px;">
                                <input type="text" id="payAddClientSearch" class="form-control form-control-sm bg-black text-white border-secondary"
                                    placeholder="üîç Buscar cliente para a√±adir a pagos..." autocomplete="off"
                                    oninput="searchClientForPayment()">
                                <div id="payAddClientList" class="suggestions-list" style="z-index:9999;"></div>
                            </div>
                            <small class="text-muted">Solo aparecen clientes con pagos. Usa el buscador para a√±adir otros.</small>
                        </div>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="d-flex gap-2 mb-3 flex-wrap align-items-center">
                    <button class="btn btn-sm btn-outline-light" id="payFilterAll" onclick="filterPayments('all')">
                        <i class="bi bi-list me-1"></i>Todos
                    </button>
                    <button class="btn btn-sm" id="payFilterPending" onclick="filterPayments('pending')"
                        style="background:#dc3545;color:white;border:none;">
                        <i class="bi bi-clock-fill me-1"></i>Pendientes
                    </button>
                    <button class="btn btn-sm" id="payFilterPaid" onclick="filterPayments('paid')"
                        style="background:#198754;color:white;border:none;">
                        <i class="bi bi-check-circle-fill me-1"></i>Pagados
                    </button>
                    <input type="text" id="paySearchInput" class="form-control form-control-sm"
                        placeholder="üîç Buscar cliente..." style="max-width:220px;margin-left:auto;"
                        oninput="renderPaymentList()">
                </div>

                <!-- Contenedor lista clientes -->
                <div class="row g-3" id="paymentsListContainer">
                    <div class="col-12 text-center text-muted py-5">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        Cargando clientes...
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="config">
                <h4 class="fw-bold text-white fs-5 mb-3">Configuraci√≥n del Sistema</h4>

                <!-- GESTI√ìN DE CATEGOR√çAS DE STOCK -->
                <div class="card bg-dark text-white p-3 mb-3 border border-secondary">
                    <h6 class="fw-bold mb-3">
                        <i class="bi bi-diagram-3-fill me-2 text-info"></i>
                        Categor√≠as y Subcategor√≠as de Stock
                    </h6>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <button class="btn btn-sm btn-info me-2" data-bs-toggle="modal"
                                data-bs-target="#modalAddCategory">
                                <i class="bi bi-plus-circle-fill me-1"></i> Nueva Categor√≠a Principal
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="loadCategoriesTree()">
                                <i class="bi bi-arrow-clockwise me-1"></i> Recargar
                            </button>
                        </div>
                    </div>

                    <div id="categoriesTree" class="border border-secondary rounded p-3 bg-black"
                        style="min-height: 200px;">
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-hourglass-split"></i> Cargando categor√≠as...
                        </div>
                    </div>
                </div>

                <!-- TIPOS DE SERVICIO -->
                <div class="card bg-dark text-white p-3 mb-3 border border-secondary">
                    <h6 class="fw-bold mb-3"><i class="bi bi-wrench-adjustable-circle-fill me-2 text-warning"></i>
                        Tipos de Servicio</h6>
                    <button class="btn btn-sm btn-warning mb-3" data-bs-toggle="modal"
                        data-bs-target="#modalAddService">
                        <i class="bi bi-plus-circle-fill me-1"></i> A√±adir Tipo de Servicio
                    </button>
                    <div class="table-responsive">
                        <table class="table table-dark table-sm">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Color</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for s in services %}
                                <tr>
                                    <td>{{ s.name }}</td>
                                    <td><span class="badge service-color-badge" data-bg-color="{{ s.color }}">{{ s.color
                                            }}</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-warning" data-service-id="{{ s.id }}"
                                            data-service-name="{{ s.name }}" data-service-color="{{ s.color }}"
                                            onclick="openEditServiceModal(this.dataset.serviceId, this.dataset.serviceName, this.dataset.serviceColor)">
                                            <i class="bi bi-pencil-fill"></i>
                                        </button>
                                        <form method="POST" action="/manage_services" class="d-inline">
                                            <input type="hidden" name="action" value="delete">
                                            <input type="hidden" name="service_id" value="{{ s.id }}">
                                            <button class="btn btn-sm btn-outline-danger"
                                                onclick="return confirm('¬øEliminar este tipo de servicio?')">
                                                <i class="bi bi-trash-fill"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALES -->
    <!-- Modal: A√±adir Usuario -->
    <div class="modal fade" id="modalAddUser" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Nuevo Usuario</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/manage_users">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="add">
                        <label class="form-label">Usuario</label>
                        <input type="text" name="username" class="form-control mb-2" required>
                        <label class="form-label">Contrase√±a</label>
                        <input type="password" name="password" class="form-control mb-2" required id="newUserPassword">
                        <div class="alert alert-secondary py-2 px-3 mb-2" style="font-size:0.78rem;background:#1e1e1e;border:1px solid #444;color:#aaa;">
                            <i class="bi bi-info-circle me-1 text-info"></i>
                            M√≠nimo 6 caracteres, con: <b class="text-warning">may√∫scula</b>, <b class="text-warning">min√∫scula</b>, <b class="text-warning">n√∫mero</b> y <b class="text-warning">car√°cter especial</b> (ej: <code>!</code><code>@</code><code>#</code><code>$</code>).<br>
                            <span class="text-muted">Ejemplo v√°lido: <code>Tecnico1!</code></span>
                        </div>
                        <label class="form-label">Email</label>
                        <input type="email" name="email" class="form-control mb-2" required
                            placeholder="ejemplo@oslaprint.com">
                        <label class="form-label">Rol</label>
                        <select name="role" class="form-select" required>
                            <option value="tech">T√©cnico</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="submit" class="btn btn-warning">Crear</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Eliminar Usuario -->
    <div class="modal fade" id="modalDeleteUser" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-danger">Confirmar Eliminaci√≥n</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/manage_users">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="delete">
                        <input type="hidden" name="user_id" id="deleteUserId">
                        <p>¬øSeguro que deseas eliminar este usuario? Todas sus tareas tambi√©n ser√°n eliminadas.</p>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">Eliminar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Cambiar Nombre de Usuario -->
    <div class="modal fade" id="modalRenameUser" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"><i class="bi bi-pencil-fill me-2 text-warning"></i>Cambiar Nombre de Usuario</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/manage_users">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="rename">
                        <input type="hidden" name="user_id" id="renameUserId">
                        <p class="text-muted mb-3">Renombrando al usuario: <strong class="text-white" id="renameCurrentUsername"></strong></p>
                        <label class="form-label">Nuevo nombre de usuario</label>
                        <input type="text" name="new_username" id="renameNewUsername" class="form-control" required
                            placeholder="Introduce el nuevo nombre...">
                        <small class="text-muted mt-1 d-block">Este nombre tambi√©n se usar√° para iniciar sesi√≥n.</small>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning"><i class="bi bi-check-lg me-1"></i>Guardar Cambio</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Cambiar Contrase√±a -->
    <div class="modal fade" id="modalChangePassword" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Cambiar Contrase√±a</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/change_password">
                    <div class="modal-body">
                        <label class="form-label">Contrase√±a Actual</label>
                        <input type="password" name="current_password" class="form-control mb-2" required>
                        <label class="form-label">Nueva Contrase√±a</label>
                        <input type="password" name="new_password" class="form-control" required>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="submit" class="btn btn-warning">Actualizar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: A√±adir Stock -->
    <div class="modal fade" id="modalAddStock" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"><i class="bi bi-box-seam-fill me-2"></i>Nuevo Art√≠culo de Stock</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <!-- ‚úÖ CORREGIDO: usar AJAX en lugar de POST directo para controlar subcategory_id -->
                <form id="formAddStock">
                    <div class="modal-body">
                        <div id="addStockAlert" class="alert d-none mb-3" role="alert"></div>

                        <div class="mb-3">
                            <label class="form-label">Nombre del Producto *</label>
                            <input type="text" name="name" id="addStockName" class="form-control" required
                                placeholder="Ej: Caj√≥n Cashlogy 1500">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Categor√≠a * <small class="text-muted">(Obligatorio)</small></label>
                            <select name="category_id" id="addStockCategory" class="form-select" required
                                onchange="loadSubcategories(this.value, 'addStockSubcategory')">
                                <option value="">-- Seleccionar Categor√≠a --</option>
                            </select>
                        </div>

                        <div class="mb-3" id="subcategorySection" style="display: none;">
                            <label class="form-label">Subcategor√≠a <small class="text-muted">(Opcional)</small></label>
                            <select name="subcategory_id" id="addStockSubcategory" class="form-select">
                                <option value="">-- Sin subcategor√≠a (guardar en categor√≠a padre) --</option>
                            </select>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Stock Actual *</label>
                                <input type="number" name="quantity" class="form-control" value="0" required min="0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Stock M√≠nimo *</label>
                                <input type="number" name="min_stock" class="form-control" value="5" required min="0">
                                <small class="text-muted">Se activar√° alerta cuando est√© por debajo</small>
                            </div>
                        </div>

                        <!-- ‚úÖ NUEVO: Campo Proveedor -->
                        <div class="mb-3">
                            <label class="form-label">Proveedor</label>
                            <input type="text" name="supplier" class="form-control"
                                placeholder="Ej: HP Espa√±a, Canon Iberia...">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Descripci√≥n</label>
                            <textarea name="description" class="form-control" rows="2"
                                placeholder="Detalles adicionales del producto"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning" id="btnAddStockSubmit">
                            <i class="bi bi-plus-circle-fill me-1"></i>A√±adir Producto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Ajustar Stock -->
    <div class="modal fade" id="modalAdjustStock" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Ajustar Cantidad</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/manage_stock">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="adjust">
                        <input type="hidden" name="item_id" id="adjId">
                        <p>Art√≠culo: <strong id="adjName"></strong></p>
                        <label class="form-label">Cantidad a A√±adir/Restar (use - para restar)</label>
                        <input type="number" name="adjust_qty" class="form-control" required>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="submit" class="btn btn-warning">Ajustar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Editar Stock Completo -->
    <div class="modal fade" id="modalEditStock" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Editar Art√≠culo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/manage_stock">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="edit">
                        <input type="hidden" name="item_id" id="editFullId">
                        <label class="form-label">Nombre</label>
                        <input type="text" name="name" id="editFullName" class="form-control mb-2" required>
                        <label class="form-label">Categor√≠a</label>
                        <input type="text" name="category" id="editFullCat" class="form-control mb-2" required>
                        <label class="form-label">Cantidad</label>
                        <input type="number" name="quantity" id="editFullQty" class="form-control" required>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="submit" class="btn btn-warning">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Editar Art√≠culo de Stock (COMPLETO) -->
    <div class="modal fade" id="modalEditStockItem" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"><i class="bi bi-box-seam me-2"></i>Editar Art√≠culo de Stock</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="formEditStockItem" method="POST" action="/edit_stock_item/0">
                    <div class="modal-body">
                        <input type="hidden" name="item_id" id="editStockItemId">

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nombre del Art√≠culo *</label>
                                <input type="text" name="name" id="editStockItemName" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Categor√≠a</label>
                                <select name="category_id" id="editStockItemCategory" class="form-select">
                                    <option value="">Sin categor√≠a</option>
                                    {% for cat in all_categories %}
                                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Cantidad Actual *</label>
                                <input type="number" name="quantity" id="editStockItemQuantity" class="form-control"
                                    min="0" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Stock M√≠nimo *</label>
                                <input type="number" name="min_stock" id="editStockItemMinStock" class="form-control"
                                    min="0" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Proveedor</label>
                                <input type="text" name="supplier" id="editStockItemSupplier" class="form-control"
                                    placeholder="Opcional">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Descripci√≥n / Notas</label>
                            <textarea name="description" id="editStockItemDescription" class="form-control" rows="3"
                                placeholder="Informaci√≥n adicional sobre el art√≠culo..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-save me-1"></i>Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Editar Categor√≠a de Stock -->
    <div class="modal fade" id="modalEditCategory" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"><i class="bi bi-folder-fill me-2"></i>Editar Categor√≠a</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/edit_stock_category">
                    <div class="modal-body">
                        <input type="hidden" name="category_id" id="editCategoryId">

                        <div class="mb-3">
                            <label class="form-label">Nombre de la Categor√≠a *</label>
                            <input type="text" name="name" id="editCategoryName" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Categor√≠a Padre (Opcional)</label>
                            <select name="parent_id" id="editCategoryParent" class="form-select">
                                <option value="">-- Sin padre (categor√≠a principal) --</option>
                                {% for cat in all_categories %}
                                <option value="{{ cat.id }}">{{ cat.name }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Si seleccionas una categor√≠a padre, esta se convertir√° en subcategor√≠a
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-save me-1"></i>Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: A√±adir Cliente -->
    <div class="modal fade" id="modalAddClient" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"><i class="bi bi-person-plus-fill me-2"></i>Nuevo Cliente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/manage_clients">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="add">

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nombre del Cliente *</label>
                                <input type="text" name="name" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tel√©fono *</label>
                                <input type="tel" name="phone" class="form-control" required
                                    placeholder="Ej: 912345678">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Correo Electr√≥nico *</label>
                                <input type="email" name="email" class="form-control" required
                                    placeholder="ejemplo@email.com">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Enlace/URL (Opcional)</label>
                                <input type="url" name="link" class="form-control" placeholder="https://ejemplo.com">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>Portal web, sistema interno, etc.
                                </small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Direcci√≥n Completa *</label>
                            <input type="text" name="address" id="clientAddress" class="form-control" required
                                placeholder="Calle, n√∫mero, ciudad">
                            <a href="#" id="openGoogleMaps" class="small text-info mt-1 d-block" target="_blank"
                                style="display:none;">
                                <i class="bi bi-geo-alt-fill me-1"></i>Abrir en Google Maps
                            </a>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Notas Internas</label>
                            <textarea name="notes" class="form-control" rows="2"
                                placeholder="Comentarios internos sobre el cliente"></textarea>
                        </div>

                        <hr class="border-secondary">

                        <div class="mb-3">
                            <label class="form-label fw-bold">¬øTiene Soporte T√©cnico Contratado?</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="hasSupportSwitch"
                                    name="has_support" onchange="toggleSupportSchedule('addSupportScheduleDiv', this.checked)">
                                <label class="form-check-label" for="hasSupportSwitch">
                                    S√≠, tiene soporte t√©cnico
                                </label>
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Marca esta opci√≥n si el cliente tiene contratado soporte t√©cnico con OSLAPRINT
                            </small>
                        </div>

                        <!-- ‚úÖ NUEVO: Horario de soporte -->
                        <div class="mb-3" id="addSupportScheduleDiv" style="display:none;">
                            <label class="form-label fw-bold text-info"><i class="bi bi-clock me-1"></i>Horario de Soporte</label>
                            <div class="d-flex gap-3 flex-wrap">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="support_schedule" id="addSched_lv" value="lv" checked>
                                    <label class="form-check-label" for="addSched_lv">
                                        <i class="bi bi-calendar-week me-1 text-success"></i>Lunes a Viernes
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="support_schedule" id="addSched_ls" value="ls">
                                    <label class="form-check-label" for="addSched_ls">
                                        <i class="bi bi-calendar-week me-1 text-warning"></i>Lunes a S√°bado
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="support_schedule" id="addSched_ld" value="ld">
                                    <label class="form-check-label" for="addSched_ld">
                                        <i class="bi bi-calendar-week me-1 text-danger"></i>Lunes a Domingo
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-save-fill me-1"></i>Guardar Cliente
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Editar Cliente -->
    <div class="modal fade" id="modalEditClient" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Editar Cliente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/manage_clients">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="edit">
                        <input type="hidden" name="client_id" id="editClientId">

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nombre del Cliente *</label>
                                <input type="text" name="name" id="editClientName" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tel√©fono *</label>
                                <input type="tel" name="phone" id="editClientPhone" class="form-control" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Correo Electr√≥nico *</label>
                                <input type="email" name="email" id="editClientEmail" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Enlace/URL (Opcional)</label>
                                <input type="url" name="link" id="editClientLink" class="form-control"
                                    placeholder="https://ejemplo.com">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Direcci√≥n Completa *</label>
                            <input type="text" name="address" id="editClientAddress" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Notas Internas</label>
                            <textarea name="notes" id="editClientNotes" class="form-control" rows="2"></textarea>
                        </div>

                        <hr class="border-secondary">

                        <div class="mb-3">
                            <label class="form-label fw-bold">¬øTiene Soporte T√©cnico Contratado?</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="editHasSupport" name="has_support"
                                    onchange="toggleSupportSchedule('editSupportScheduleDiv', this.checked)">
                                <label class="form-check-label" for="editHasSupport">
                                    S√≠, tiene soporte t√©cnico
                                </label>
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Marca esta opci√≥n si el cliente tiene contratado soporte t√©cnico con OSLAPRINT
                            </small>
                        </div>

                        <!-- ‚úÖ NUEVO: Horario de soporte en edici√≥n -->
                        <div class="mb-3" id="editSupportScheduleDiv" style="display:none;">
                            <label class="form-label fw-bold text-info"><i class="bi bi-clock me-1"></i>Horario de Soporte</label>
                            <div class="d-flex gap-3 flex-wrap">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="support_schedule" id="editSched_lv" value="lv">
                                    <label class="form-check-label" for="editSched_lv">
                                        <i class="bi bi-calendar-week me-1 text-success"></i>Lunes a Viernes
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="support_schedule" id="editSched_ls" value="ls">
                                    <label class="form-check-label" for="editSched_ls">
                                        <i class="bi bi-calendar-week me-1 text-warning"></i>Lunes a S√°bado
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="support_schedule" id="editSched_ld" value="ld">
                                    <label class="form-check-label" for="editSched_ld">
                                        <i class="bi bi-calendar-week me-1 text-danger"></i>Lunes a Domingo
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-save-fill me-1"></i>Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ‚úÖ NUEVO Modal: Perfil de T√©cnico -->
    <div class="modal fade" id="modalTechProfile" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-person-lines-fill me-2 text-warning"></i>
                        Perfil T√©cnico: <span id="techProfileUsername" class="text-warning"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="techProfileAlert" class="alert d-none mb-3"></div>
                    <input type="hidden" id="techProfileUserId">

                    <!-- Tabs del perfil -->
                    <ul class="nav nav-tabs mb-3 border-secondary" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active text-white" data-bs-toggle="tab" data-bs-target="#tabPersonal">
                                <i class="bi bi-person me-1"></i>Datos Personales
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link text-white" data-bs-toggle="tab" data-bs-target="#tabLaboral">
                                <i class="bi bi-briefcase me-1"></i>Datos Laborales
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link text-white" data-bs-toggle="tab" data-bs-target="#tabNotas">
                                <i class="bi bi-sticky me-1"></i>Notas Internas
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- DATOS PERSONALES -->
                        <div class="tab-pane fade show active" id="tabPersonal">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nombre Completo</label>
                                    <input type="text" id="tp_full_name" class="form-control" placeholder="Nombre y apellidos">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">DNI / NIE</label>
                                    <input type="text" id="tp_dni" class="form-control" placeholder="12345678A">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Tel√©fono</label>
                                    <input type="tel" id="tp_phone" class="form-control" placeholder="6XX XXX XXX">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Direcci√≥n</label>
                                    <input type="text" id="tp_address" class="form-control" placeholder="Calle, n√∫mero, ciudad">
                                </div>
                            </div>
                            <hr class="border-secondary">
                            <h6 class="text-info mb-3"><i class="bi bi-telephone-fill me-2"></i>Contacto de Emergencia</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nombre del Contacto</label>
                                    <input type="text" id="tp_emergency_contact" class="form-control" placeholder="Nombre del familiar/contacto">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Tel√©fono de Emergencia</label>
                                    <input type="tel" id="tp_emergency_phone" class="form-control" placeholder="6XX XXX XXX">
                                </div>
                            </div>
                        </div>

                        <!-- DATOS LABORALES -->
                        <div class="tab-pane fade" id="tabLaboral">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Fecha de Incorporaci√≥n</label>
                                    <input type="date" id="tp_start_date" class="form-control">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Email del Sistema</label>
                                    <input type="email" id="tp_email_display" class="form-control" disabled style="opacity:0.7;">
                                    <small class="text-muted">El email se gestiona desde el panel de usuarios</small>
                                </div>
                            </div>
                        </div>

                        <!-- NOTAS INTERNAS -->
                        <div class="tab-pane fade" id="tabNotas">
                            <div class="mb-1">
                                <label class="form-label">Notas Internas del Administrador</label>
                                <div class="alert alert-warning py-2 small mb-2">
                                    <i class="bi bi-eye-slash me-1"></i>
                                    Estas notas son <strong>solo visibles para el administrador</strong>. El t√©cnico no tiene acceso a ellas.
                                </div>
                                <textarea id="tp_internal_notes" class="form-control" rows="7"
                                    placeholder="Observaciones internas, evaluaciones, incidencias, etc..."></textarea>
                            </div>
                            <div id="techProfileUpdatedAt" class="text-muted small mt-2"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-warning fw-bold" onclick="saveTechProfile()" id="btnSaveTechProfile">
                        <i class="bi bi-save-fill me-1"></i>Guardar Perfil
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Importar Clientes -->
    <div class="modal fade" id="modalImportClients" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Importar Clientes (JSON)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/import_clients" enctype="multipart/form-data">
                    <div class="modal-body">
                        <label class="form-label">Archivo JSON</label>
                        <input type="file" name="file" class="form-control" accept=".json" required>
                        <small class="text-muted">Formato esperado: [{"name": "Cliente1"}, {"name":
                            "Cliente2"}]</small>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="submit" class="btn btn-info">Importar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: A√±adir Tipo de Servicio -->
    <div class="modal fade" id="modalAddService" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Nuevo Tipo de Servicio</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/manage_services">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="add">
                        <label class="form-label">Nombre</label>
                        <input type="text" name="name" class="form-control mb-2" required>
                        <label class="form-label">Color (Hex)</label>
                        <input type="color" name="color" class="form-control" value="#6c757d" required>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="submit" class="btn btn-warning">A√±adir</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Editar Tipo de Servicio -->
    <div class="modal fade" id="modalEditService" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Editar Tipo de Servicio</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/manage_services">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="edit">
                        <input type="hidden" name="service_id" id="editServiceId">
                        <label class="form-label">Nombre</label>
                        <input type="text" name="name" id="editServiceName" class="form-control mb-2" required>
                        <label class="form-label">Color (Hex)</label>
                        <input type="color" name="color" id="editServiceColor" class="form-control" required>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="submit" class="btn btn-warning">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Agendar Cita -->
    <div class="modal fade" id="modalScheduleAppointment" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Agendar Nueva Cita</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="formScheduleAppointment">
                    <div class="modal-body">
                        <label class="form-label">T√©cnicos <span class="text-muted small">(opcional)</span></label>
                        <div class="border border-secondary rounded p-2 mb-2" style="max-height:130px;overflow-y:auto;background:#111;">
                            {% for u in empleados %}
                            <div class="form-check">
                                <input class="form-check-input tech-checkbox" type="checkbox"
                                    name="tech_ids[]" value="{{ u.id }}"
                                    id="schedTech{{ u.id }}">
                                <label class="form-check-label text-white" for="schedTech{{ u.id }}">
                                    {{ u.username }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        <small class="text-info d-block mb-1">
                            <i class="bi bi-info-circle me-1"></i>
                            Sin t√©cnico: la cita queda como <strong>Sin asignar</strong> y cualquier t√©cnico puede completarla.
                        </small>
                        <label class="form-label mt-1">Cliente</label>
                        <div class="position-relative mb-2">
                            <input type="text" name="client_name" id="scheduleClientInput" class="form-control" required
                                autocomplete="off">
                            <div id="scheduleClientList" class="suggestions-list"></div>
                        </div>
                        <label class="form-label">Fecha</label>
                        <input type="date" name="date" class="form-control mb-2" required>
                        <label class="form-label">Hora</label>
                        <input type="time" name="time" class="form-control mb-2" required>
                        <label class="form-label">Hora Fin (opcional)</label>
                        <input type="time" name="end_time" class="form-control mb-2">
                        <label class="form-label">Tipo de Servicio</label>
                        <select name="service_type" class="form-select mb-2" required>
                            {% for svc in all_service_types %}
                            <option value="{{ svc.name }}">{{ svc.name }}</option>
                            {% endfor %}
                        </select>
                        <label class="form-label">Notas</label>
                        <textarea name="notes" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-warning" onclick="submitScheduleForm()" id="scheduleSubmitBtn">Agendar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Crear Tarea Sin T√©cnico -->
    <div class="modal fade" id="modalCreateUnassignedTask" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary bg-danger bg-opacity-10">
                    <h5 class="modal-title"><i class="bi bi-exclamation-circle me-2"></i>Crear Tarea Pendiente por Asignar</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="formCreateUnassignedTask">
                    <div class="modal-body">
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                            <i class="bi bi-info-circle me-1"></i>
                            Esta tarea <strong>no tendr√° fecha ni t√©cnico asignado</strong>. Deber√° ser asignada desde el apartado de tareas pendientes.
                        </div>
                        <label class="form-label">Cliente</label>
                        <div class="position-relative mb-2">
                            <input type="text" name="client_name" id="unassignedClientInput" class="form-control" required autocomplete="off">
                            <div id="unassignedClientList" class="suggestions-list"></div>
                        </div>
                        <label class="form-label">Tipo de Servicio</label>
                        <select name="service_type_id" id="unassignedServiceType" class="form-select mb-2" required>
                            <option value="">-- Seleccionar --</option>
                            {% for svc in all_service_types %}
                            <option value="{{ svc.id }}">{{ svc.name }}</option>
                            {% endfor %}
                        </select>
                        <label class="form-label">Descripci√≥n/Notas</label>
                        <textarea name="description" id="unassignedDescription" class="form-control" rows="3" placeholder="Describa el trabajo a realizar..."></textarea>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-danger" onclick="submitUnassignedTaskForm()" id="unassignedSubmitBtn">Crear Tarea</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ‚úÖ NUEVO: Modal para Asistencia Remota -->
    <div class="modal fade" id="modalRemoteAssistance" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary bg-info bg-opacity-10">
                    <h5 class="modal-title"><i class="bi bi-telephone-fill me-2"></i>Crear Asistencia Remota</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="formRemoteAssistance">
                    <div class="modal-body">
                        <div class="alert alert-info alert-dismissible fade show" role="alert">
                            <i class="bi bi-info-circle me-1"></i>
                            B√∫squeda y creaci√≥n r√°pida de asistencia remota para clientes.
                        </div>

                        <!-- B√∫squeda de cliente -->
                        <label class="form-label fw-bold">Buscar Cliente</label>
                        <div class="position-relative mb-3">
                            <input type="text" id="remoteClientSearch" class="form-control" placeholder="Escriba nombre del cliente..." autocomplete="off">
                            <div id="remoteClientsList" class="suggestions-list"></div>
                        </div>

                        <!-- Ficha del cliente (se muestra al seleccionar) -->
                        <div id="remoteClientCard" style="display:none;" class="card bg-secondary bg-opacity-25 border-info mb-3">
                            <div class="card-body">
                                <h6 class="card-title text-info" id="remoteClientName">-</h6>
                                <small class="d-block text-muted">
                                    <i class="bi bi-telephone me-1"></i><span id="remoteClientPhone">-</span><br>
                                    <i class="bi bi-envelope me-1"></i><span id="remoteClientEmail">-</span><br>
                                    <i class="bi bi-house me-1"></i><span id="remoteClientAddress">-</span><br>
                                    <span class="badge bg-success" id="remoteSupportBadge" style="display:none;">Con Soporte</span>
                                    <span class="badge bg-danger" id="remoteSupportBadgeNo" style="display:none;">Sin Soporte</span>
                                </small>
                            </div>
                        </div>

                        <input type="hidden" id="remoteSelectedClientId">
                        <input type="hidden" id="remoteSelectedClientName">

                        <!-- Descripci√≥n -->
                        <label class="form-label">Descripci√≥n del trabajo</label>
                        <textarea id="remoteDescription" class="form-control" rows="3" placeholder="Describa brevemente el trabajo a realizar..."></textarea>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-info" onclick="submitRemoteAssistance()" id="remoteSubmitBtn">
                            <i class="bi bi-plus-lg me-1"></i>Crear Asistencia
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalEditAppointmentAdmin" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Editar Cita</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" id="formEditApptAdmin">
                    <div class="modal-body">
                        <label class="form-label">Cliente</label>
                        <div class="position-relative mb-2">
                            <input type="text" name="client_name" id="editAdminClientInput" class="form-control"
                                required autocomplete="off">
                            <div id="editAdminClientList" class="suggestions-list"></div>
                        </div>
                        <label class="form-label">Fecha</label>
                        <input type="date" name="date" id="editAdminDate" class="form-control mb-2" required>
                        <label class="form-label">Hora</label>
                        <input type="time" name="time" id="editAdminTime" class="form-control mb-2" required>
                        <label class="form-label">Tipo de Servicio</label>
                        <select name="service_type" id="editAdminService" class="form-select mb-2" required>
                            {% for svc in all_service_types %}
                            <option value="{{ svc.name }}">{{ svc.name }}</option>
                            {% endfor %}
                        </select>
                        <label class="form-label">Notas</label>
                        <textarea name="notes" id="editAdminNotes" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="submit" class="btn btn-warning">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Acciones Tarea Admin -->
    <div class="modal fade" id="modalActionAdmin" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Acciones sobre la Tarea</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="evtId">
                    <p><strong>Cliente:</strong> <span id="evtClient"></span></p>
                    <p><strong>T√©cnico:</strong> <span id="evtTech"></span></p>
                    <p><strong>Servicio:</strong> <span id="evtService"></span></p>
                    <p><strong>Estado:</strong> <span id="evtStatus"></span></p>
                    <p><strong>Descripci√≥n:</strong><br><span id="evtDesc"></span></p>

                    <!-- Secci√≥n de Archivos Adjuntos -->
                    <div id="attachmentsSection" class="mt-3" style="display: none;">
                        <hr class="border-secondary">
                        <p class="fw-bold mb-2"><i class="bi bi-paperclip me-1"></i> Archivos Adjuntos:</p>
                        <div id="attachmentsList" class="list-group"></div>
                    </div>

                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-info" onclick="viewTaskDetails()">
                            <i class="bi bi-eye-fill me-1"></i> Ver Detalles Completos
                        </button>
                        <button class="btn btn-warning" onclick="openEditAdminModal()">
                            <i class="bi bi-pencil-fill me-1"></i> Editar Cita
                        </button>
                        <button class="btn btn-success" onclick="performAdminTaskAction('complete')">
                            <i class="bi bi-check-circle-fill me-1"></i> Marcar Completado
                        </button>
                        <button class="btn btn-danger" onclick="performAdminTaskAction('delete')">
                            <i class="bi bi-trash-fill me-1"></i> Eliminar Tarea
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal: Detalles Completos de la Tarea -->
    <div class="modal fade" id="modalTaskDetails" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-file-text-fill me-2 text-warning"></i>
                        Detalles del Parte de Trabajo
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="mb-2"><strong class="text-warning">Cliente:</strong><br>
                                <span id="detailClient"></span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2"><strong class="text-warning">T√©cnico:</strong><br>
                                <span id="detailTech"></span>
                            </p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <p class="mb-2"><strong class="text-warning">Fecha:</strong><br>
                                <span id="detailDate"></span>
                            </p>
                        </div>
                        <div class="col-md-4">
                            <p class="mb-2"><strong class="text-warning">Hora Entrada:</strong><br>
                                <span id="detailStartTime"></span>
                            </p>
                        </div>
                        <div class="col-md-4">
                            <p class="mb-2"><strong class="text-warning">Hora Salida:</strong><br>
                                <span id="detailEndTime"></span>
                            </p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="mb-2"><strong class="text-warning">Servicio:</strong><br>
                                <span id="detailService"></span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2"><strong class="text-warning">Estado:</strong><br>
                                <span id="detailStatus"></span>
                            </p>
                        </div>
                    </div>

                    <div class="mb-3">
                        <p class="mb-2"><strong class="text-warning">Descripci√≥n del Trabajo:</strong></p>
                        <div class="p-3 bg-black rounded border border-secondary" id="detailDescription"></div>
                    </div>

                    <div id="detailStockSection" class="mb-3" style="display: none;">
                        <p class="mb-2"><strong class="text-warning">Material Utilizado/Retirado:</strong></p>
                        <div class="p-3 bg-black rounded border border-secondary" id="detailStock"></div>
                    </div>

                    <div id="detailPartsSection" class="mb-3" style="display: none;">
                        <p class="mb-2"><strong class="text-warning">Notas/Material Adicional:</strong></p>
                        <div class="p-3 bg-black rounded border border-secondary" id="detailParts"></div>
                    </div>

                    <!-- Archivos Adjuntos -->
                    <div id="detailAttachmentsSection" class="mb-3" style="display: none;">
                        <p class="mb-2"><strong class="text-warning">
                                <i class="bi bi-paperclip me-1"></i> Archivos Adjuntos:
                            </strong></p>
                        <div id="detailAttachmentsList" class="list-group"></div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <a id="printReportLink" href="#" target="_blank" class="btn btn-warning">
                        <i class="bi bi-printer-fill me-1"></i> Imprimir Parte
                    </a>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal: A√±adir Categor√≠a de Stock -->
    <div class="modal fade" id="modalAddCategory" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Nueva Categor√≠a/Subcategor√≠a</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="categoryForm">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="add">

                        <div class="mb-3">
                            <label class="form-label">Nombre *</label>
                            <input type="text" name="name" id="categoryName" class="form-control" required
                                placeholder="Ej: TPV, Consumibles, etc.">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Tipo de Categor√≠a</label>
                            <select id="categoryType" class="form-select" onchange="toggleParentSelect()">
                                <option value="main">Categor√≠a Principal</option>
                                <option value="sub">Subcategor√≠a</option>
                            </select>
                        </div>

                        <div class="mb-3" id="parentCategoryDiv" style="display: none;">
                            <label class="form-label">Categor√≠a Padre *</label>
                            <select name="parent_id" id="parentCategorySelect" class="form-select">
                                <option value="">-- Seleccionar --</option>
                            </select>
                        </div>

                        <div class="alert alert-info small">
                            <i class="bi bi-info-circle me-1"></i>
                            Las subcategor√≠as se crean dentro de categor√≠as principales existentes.
                        </div>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-info">
                            <i class="bi bi-plus-circle-fill me-1"></i>Crear
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Modal: Archivos Adjuntos del Informe -->
    <div class="modal fade" id="modalAttachments" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-paperclip me-2"></i>
                        Archivos Adjuntos ‚Äî <span id="attachModalClient"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="attachmentsListContainer">
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-hourglass-split"></i> Cargando archivos...
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Horas de trabajo del cliente este mes -->
    <div class="modal fade" id="modalClientWorkHours" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-stopwatch me-2 text-warning"></i>
                        Registro de horas ‚Äî <span id="workHoursClientName"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="workHoursContent">
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-hourglass-split"></i> Cargando...
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Modal: Estad√≠sticas del T√©cnico -->
    <div class="modal fade" id="modalTechStats" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-graph-up me-2 text-info"></i>
                        Estad√≠sticas del T√©cnico
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="techStatsContent">
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-hourglass-split"></i> Selecciona un t√©cnico...
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        var calendar = null;
        var calendarGlobalInstance = null;
        var modalActionAdmin = new bootstrap.Modal(document.getElementById('modalActionAdmin'));
        var currentEmployeeId = null;
        var cachedAdminTasks = []; // ‚úÖ NUEVO: Cach√© de tareas del empleado
        var cachedGlobalTasks = []; // ‚úÖ NUEVO: Cach√© de tareas globales

        /**
         * Devuelve '#000000' o '#ffffff' seg√∫n cu√°l ofrezca mayor contraste
         * sobre el color hexadecimal de fondo dado. Usado en el calendario global.
         */
        function getContrastColor(hex) {
            try {
                var h = (hex || '#6c757d').replace('#', '');
                if (h.length === 3) { h = h[0]+h[0]+h[1]+h[1]+h[2]+h[2]; }
                var r = parseInt(h.substring(0,2), 16);
                var g = parseInt(h.substring(2,4), 16);
                var b = parseInt(h.substring(4,6), 16);
                // F√≥rmula de luminancia perceptiva (W3C)
                var luminance = (0.299*r + 0.587*g + 0.114*b) / 255;
                return luminance > 0.55 ? '#000000' : '#ffffff';
            } catch(e) { return '#ffffff'; }
        }

        // Aplicar colores din√°micos a los labels de filtros
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('label[data-color]').forEach(function (label) {
                const color = label.dataset.color;
                label.style.borderColor = color;
                label.style.color = color;
            });
        });

        setupAutocomplete('scheduleClientInput', 'scheduleClientList');
        setupAutocomplete('unassignedClientInput', 'unassignedClientList');

        function loadEmployeeCalendar(userId) {
            currentEmployeeId = userId;
            document.getElementById('calendarAdminContainer').style.display = 'block';
            document.getElementById('empCalendarTitle').innerText = `Calendario de Empleado #${userId}`;

            if (calendar) {
                calendar.destroy();
            }

            var calendarEl = document.getElementById('calendarAdmin');
            var isMobile = window.innerWidth < 768;

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: isMobile ? 'listWeek' : 'dayGridMonth',
                locale: 'es',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                },
                buttonText: {
                    today: 'Hoy',
                    month: 'Mes',
                    week: 'Semana',
                    day: 'D√≠a',
                    list: 'Lista'
                },
                height: 'auto',
                navLinks: true,
                editable: false,
                dayMaxEvents: true,
                events: `/api/admin/tasks/${userId}`,
                eventClick: handleEventClick,
                dateClick: handleAdminDateClick,
                selectable: true,
                eventContent: function (arg) {
                    let statusIcon = arg.event.extendedProps.status === 'Completado' ? '‚úÖ' : '‚è≥';
                    return { html: `<div class="fc-content overflow-hidden text-truncate">${statusIcon} ${arg.event.title}</div>` };
                },
                eventsSet: function (events) {
                    // Serializar EventApi a objetos planos (.start es Date en FullCalendar, necesitamos string)
                    cachedAdminTasks = events.map(function(e) {
                        return {
                            id: e.id,
                            title: e.title,
                            start: e.start ? e.start.toISOString().split("T")[0] + "T" + (e.extendedProps.start_time || "00:00") : "",  // ‚úÖ FIX: Hora sin conversi√≥n timezone
                            color: e.backgroundColor || '#6c757d',
                            extendedProps: {
                                status: e.extendedProps.status,
                                client: e.extendedProps.client,
                                tech_name: e.extendedProps.tech_name,
                                service_type: e.extendedProps.service_type,
                                desc: e.extendedProps.desc
                            }
                        };
                    });
                    renderAdminTaskList();
                }
            });
            calendar.render();
        }

        function closeEmployeeCalendar() {
            document.getElementById('calendarAdminContainer').style.display = 'none';
            if (calendar) {
                calendar.destroy();
                calendar = null;
            }
        }

        function handleEventClick(info) {
            document.getElementById('evtId').value = info.event.id;
            document.getElementById('evtClient').innerText = info.event.extendedProps.client;
            document.getElementById('evtTech').innerText = info.event.extendedProps.tech_name;
            document.getElementById('evtService').innerText = info.event.extendedProps.service_type;
            document.getElementById('evtStatus').innerText = info.event.extendedProps.status;
            document.getElementById('evtDesc').innerText = info.event.extendedProps.desc || '(Sin descripci√≥n)';
            modalActionAdmin.show();
        }

        // CALENDARIO GLOBAL
        document.getElementById('tabGlobalBtn').addEventListener('click', function () {
            if (calendarGlobalInstance) {
                calendarGlobalInstance.render();
                updateGlobalFilters();
                loadUnassignedTasks();  // ‚úÖ Cargar tareas sin t√©cnico
                return;
            }
            
            // Cargar leyenda de t√©cnicos
            loadTechLegend();
            loadUnassignedTasks();  // ‚úÖ Cargar tareas sin t√©cnico

            var calendarEl = document.getElementById('calendarGlobal');
            var isMobile = window.innerWidth < 768;

            calendarGlobalInstance = new FullCalendar.Calendar(calendarEl, {
                initialView: isMobile ? 'listWeek' : 'dayGridMonth',
                locale: 'es',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                },
                buttonText: {
                    today: 'Hoy',
                    month: 'Mes',
                    week: 'Semana',
                    d√≠a: 'D√≠a',
                    list: 'Lista'
                },
                height: 'auto',
                navLinks: true,
                editable: false,
                dayMaxEvents: true,
                // Source como funci√≥n para poder filtrar sin refetch completo
                events: function(fetchInfo, successCallback, failureCallback) {
                    fetch('/api/admin/all_tasks')
                        .then(function(res) { return res.json(); })
                        .then(function(data) {
                            var activeTypes = getActiveFilters();
                            var filtered = data.filter(function(ev) {
                                var stype = ev.extendedProps ? ev.extendedProps.service_type : ev.service_type;
                                return activeTypes.length === 0 || activeTypes.includes(stype);
                            });
                            successCallback(filtered);
                        })
                        .catch(failureCallback);
                },
                dateClick: handleAdminDateClickGlobal,
                selectable: true,

                // Forzar colores del t√©cnico directamente en el DOM del evento
                eventDidMount: function (info) {
                    var bgColor  = info.event.backgroundColor  || info.event.extendedProps.tech_color || '#6c757d';
                    var txtColor = info.event.textColor         || info.event.extendedProps.text_color || getContrastColor(bgColor);

                    // Aplicar sobre el elemento ra√≠z del evento
                    info.el.style.setProperty('background-color', bgColor,  'important');
                    info.el.style.setProperty('border-color',     bgColor,  'important');
                    info.el.style.setProperty('color',             txtColor, 'important');

                    // Tambi√©n propagar a todos los hijos de texto que FC pueda crear
                    info.el.querySelectorAll('.fc-event-title, .fc-event-time, .fc-content, div, span').forEach(function(child) {
                        child.style.setProperty('color', txtColor, 'important');
                    });

                    // Estilo extra para completados
                    if (info.event.extendedProps.status === 'Completado') {
                        info.el.style.setProperty('opacity', '0.80', 'important');
                        info.el.style.setProperty('border-left', '4px solid #198754', 'important');
                    }
                },

                eventContent: function (arg) {
                    var bgColor  = arg.event.backgroundColor  || arg.event.extendedProps.tech_color || '#6c757d';
                    var txtColor = arg.event.textColor         || arg.event.extendedProps.text_color || getContrastColor(bgColor);
                    var techName   = arg.event.extendedProps.tech_name || '';
                    var title      = arg.event.title;
                    var paperclip  = arg.event.extendedProps.has_attachments ? '<i class="bi bi-paperclip ms-1" style="font-size:0.7rem;"></i>' : '';
                    var statusIcon = arg.event.extendedProps.status === 'Completado' ? '‚úì ' : '';
                    return {
                        html: '<div class="fc-content overflow-hidden text-truncate" style="font-size:0.8rem;color:' + txtColor + ';padding:1px 3px;">'
                            + '<strong>' + techName + ':</strong> ' + statusIcon + title + paperclip
                            + '</div>'
                    };
                },

                eventClick: handleEventClick,
                
                eventsSet: function (events) {
                    cachedGlobalTasks = events.map(function(e) {
                        // ‚úÖ FIX TIMEZONE: toISOString() convierte a UTC restando el offset (+1h en Espa√±a).
                        // Usamos hora local directamente para evitar el desfase de -1h.
                        function _localISO(d) {
                            if (!d) return '';
                            var pad = function(n) { return n < 10 ? '0'+n : ''+n; };
                            return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())
                                   +'T'+pad(d.getHours())+':'+pad(d.getMinutes())+':'+pad(d.getSeconds());
                        }
                        return {
                            id: e.id,
                            title: e.title,
                            start: _localISO(e.start),
                            color: e.backgroundColor || '#6c757d',
                            extendedProps: {
                                status: e.extendedProps.status,
                                client: e.extendedProps.client,
                                tech_id: e.extendedProps.tech_id,
                                tech_name: e.extendedProps.tech_name,
                                tech_color: e.extendedProps.tech_color,
                                service_type: e.extendedProps.service_type,
                                desc: e.extendedProps.desc,
                                has_attachments: e.extendedProps.has_attachments
                            }
                        };
                    });
                    renderGlobalTaskList();
                }
            });
            calendarGlobalInstance.render();
        });
        
        // Cargar y mostrar leyenda de colores de t√©cnicos
        function loadTechLegend() {
            fetch('/api/admin/tech_colors')
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.data) {
                        const container = document.getElementById('techLegendItems');
                        container.innerHTML = '';
                        data.data.forEach(tech => {
                            const span = document.createElement('span');
                            span.className = 'badge d-flex align-items-center gap-1';
                            span.style.cssText = `background-color: ${tech.color}; color: #fff; font-size: 0.85rem; padding: 6px 10px; border-radius: 20px;`;
                            span.innerHTML = `<i class="bi bi-person-fill"></i> ${tech.username}`;
                            container.appendChild(span);
                        });
                        if (data.data.length === 0) {
                            container.innerHTML = '<span class="text-muted small">No hay t√©cnicos registrados</span>';
                        }
                    }
                })
                .catch(() => {
                    document.getElementById('techLegendItems').innerHTML = '<span class="text-muted small">Error al cargar t√©cnicos</span>';
                });
        }

        // Escuchar evento Bootstrap cuando PAGOS tab se muestra (m√°s fiable que onclick)
        document.addEventListener('shown.bs.tab', function(e) {
            if (e.target && e.target.getAttribute('data-bs-target') === '#pagos') {
                loadPaymentsList();
            }
        });

        // --- L√ìGICA DE FILTRADO DIN√ÅMICO ---
        function getActiveFilters() {
            const activeTypes = [];
            document.querySelectorAll('.filter-cb:checked').forEach(cb => {
                activeTypes.push(cb.value);
            });
            return activeTypes;
        }

        function checkAllFilters() {
            document.querySelectorAll('.filter-cb').forEach(cb => {
                cb.checked = true;
            });
            updateGlobalFilters();
        }

        function updateGlobalFilters() {
            if (!calendarGlobalInstance) return;
            // refetchEvents() llama a la funci√≥n events() que aplica getActiveFilters()
            // eventsSet se dispara autom√°ticamente y actualiza la lista lateral
            calendarGlobalInstance.refetchEvents();
        }

        function refreshGlobalCalendar() {
            if (!calendarGlobalInstance) {
                alert('El calendario global no est√° inicializado');
                return;
            }

            calendarGlobalInstance.refetchEvents();

            // Mostrar feedback visual
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Actualizando...';
            btn.disabled = true;

            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }, 1000);
        }

        // ‚úÖ NUEVO: Renderizar lista de tareas del empleado
        function renderAdminTaskList() {
            const container = document.getElementById('adminTaskListContainer');
            if (!container) return;

            if (cachedAdminTasks.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-3">No hay tareas</div>';
                return;
            }

            // Ordenar por fecha
            const sorted = [...cachedAdminTasks].sort((a, b) => new Date(a.start) - new Date(b.start));

            container.innerHTML = '';
            sorted.forEach(t => {
                const isDone = t.extendedProps.status === 'Completado';
                const dateStr = t.start.split('T')[0];
                const timeStr = t.start.includes('T') ? t.start.split('T')[1].substring(0, 5) : '';
                const typeColor = t.color || '#6c757d';

                const div = document.createElement('div');
                div.className = `task-item status-${t.extendedProps.status}`;
                div.style.borderLeftColor = typeColor;
                if (isDone) div.style.opacity = '0.6';

                div.innerHTML = `
                    <div class="fw-bold text-white">${t.extendedProps.client || 'Sin cliente'}</div>
                    <div class="small text-secondary">
                        <i class="bi bi-calendar-event me-1"></i>${dateStr} ${timeStr ? '| ' + timeStr : ''}
                        <br>
                        <span class="badge ${isDone ? 'bg-success' : 'bg-warning text-dark'}">${t.extendedProps.status}</span>
                        <span class="badge" style="background:${typeColor}">${t.extendedProps.service_type || 'Sin tipo'}</span>
                    </div>
                `;
                
                div.onclick = () => {
                    const evt = calendar.getEventById(t.id);
                    if (evt) handleEventClick({ event: evt });
                };

                container.appendChild(div);
            });
        }

        // ‚úÖ NUEVO: Renderizar lista de tareas globales
        function renderGlobalTaskList() {
            const container = document.getElementById('globalTaskListContainer');
            if (!container) return;

            const showCompleted = document.getElementById('toggleCompletedGlobal')?.checked || false;
            const activeTypes = getActiveFilters();

            // Filtrar por estado Y por tipo activo
            let filtered = cachedGlobalTasks.filter(t => {
                const statusOk = showCompleted ? true : t.extendedProps.status !== 'Completado';
                const typeOk = activeTypes.length === 0 || activeTypes.includes(t.extendedProps.service_type);
                return statusOk && typeOk;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-3">No hay tareas</div>';
                return;
            }

            // Ordenar por fecha
            const sorted = [...filtered].sort((a, b) => new Date(a.start) - new Date(b.start));

            container.innerHTML = '';
            sorted.forEach(t => {
                const isDone = t.extendedProps.status === 'Completado';
                const dateStr = t.start.split('T')[0];
                const timeStr = t.start.includes('T') ? t.start.split('T')[1].substring(0, 5) : '';
                const techColor = t.extendedProps.tech_color || t.color || '#6c757d';
                const typeColor = t.color || '#6c757d';

                const div = document.createElement('div');
                div.className = `task-item status-${t.extendedProps.status}`;
                div.style.borderLeftColor = techColor;
                if (isDone) div.style.opacity = '0.6';

                div.innerHTML = `
                    <div class="fw-bold text-white">${t.extendedProps.client || 'Sin cliente'}</div>
                    <div class="small mb-1">
                        <span class="badge" style="background:${techColor}; color:#fff;"><i class="bi bi-person-fill me-1"></i>${t.extendedProps.tech_name || 'Sin t√©cnico'}</span>
                    </div>
                    <div class="small text-secondary">
                        <i class="bi bi-calendar-event me-1"></i>${dateStr} ${timeStr ? '| ' + timeStr : ''}
                        <br>
                        <span class="badge ${isDone ? 'bg-success' : 'bg-warning text-dark'}">${t.extendedProps.status}</span>
                        <span class="badge" style="background:${typeColor}; font-size:0.65rem;">${t.extendedProps.service_type || 'Sin tipo'}</span>
                    </div>
                `;
                
                div.onclick = () => {
                    const evt = calendarGlobalInstance.getEventById(t.id);
                    if (evt) handleEventClick({ event: evt });
                };

                container.appendChild(div);
            });
        }

        // --- GESTI√ìN DE ACCIONES ---
        function performAdminTaskAction(action) {
            const id = document.getElementById('evtId').value;

            const actionNames = {
                'complete': 'completar',
                'delete': 'eliminar',
                'cancel': 'cancelar'
            };

            const actionName = actionNames[action] || action;

            if (!confirm(`¬øConfirmar ${actionName} esta tarea?`)) return;

            fetch(`/api/task_action/${id}/${action}`, { method: 'POST' })
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    if (data.success) {
                        // Mostrar mensaje de √©xito
                        const successMsg = action === 'delete' ? 'Tarea eliminada correctamente' :
                            action === 'complete' ? 'Tarea marcada como completada' :
                                'Acci√≥n completada correctamente';

                        // Refrescar calendarios PRIMERO
                        if (calendar) calendar.refetchEvents();
                        if (calendarGlobalInstance) calendarGlobalInstance.refetchEvents();

                        // Cerrar modal
                        modalActionAdmin.hide();

                        // Mostrar confirmaci√≥n despu√©s de cerrar modal
                        setTimeout(() => {
                            alert('‚úì ' + successMsg);
                        }, 100);
                    } else {
                        alert('‚ùå Error: ' + (data.msg || 'No se pudo completar la acci√≥n'));
                    }
                })
                .catch(err => {
                    console.error('Error en performAdminTaskAction:', err);
                    alert('‚ùå Error de conexi√≥n. Por favor, intenta de nuevo.');
                });
        }

        // --- HELPERS Y MODALES ---
        function ajustarStock(id, name) {
            document.getElementById('adjId').value = id;
            document.getElementById('adjName').innerText = name;
            new bootstrap.Modal(document.getElementById('modalAdjustStock')).show();
        }

        function openEditStockModal(id, name, category, qty) {
            document.getElementById('editFullId').value = id;
            document.getElementById('editFullName').value = name;
            document.getElementById('editFullCat').value = category;
            document.getElementById('editFullQty').value = qty;
            new bootstrap.Modal(document.getElementById('modalEditStock')).show();
        }

        function openEditClientModal(id, name) {
            // Redirige a la funci√≥n completa
            openEditClientModalFull(id);
        }

        // Carga el cliente v√≠a API para evitar errores de caracteres especiales en inline JS
        function openEditClientModalFull(clientId) {
            // Mostrar modal con spinner mientras carga
            document.getElementById('editClientId').value = clientId;
            document.getElementById('editClientName').value = '';
            document.getElementById('editClientPhone').value = '';
            document.getElementById('editClientEmail').value = '';
            document.getElementById('editClientAddress').value = '';
            document.getElementById('editClientLink').value = '';
            document.getElementById('editClientNotes').value = '';
            document.getElementById('editHasSupport').checked = false;
            toggleSupportSchedule('editSupportScheduleDiv', false);

            new bootstrap.Modal(document.getElementById('modalEditClient')).show();

            // Cargar datos reales desde API
            fetch('/api/client/' + clientId)
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    if (data.success && data.client) {
                        var c = data.client;
                        document.getElementById('editClientId').value = c.id;
                        document.getElementById('editClientName').value = c.name;
                        document.getElementById('editClientPhone').value = c.phone;
                        document.getElementById('editClientEmail').value = c.email;
                        document.getElementById('editClientAddress').value = c.address;
                        document.getElementById('editClientLink').value = c.link || '';
                        document.getElementById('editClientNotes').value = c.notes || '';
                        document.getElementById('editHasSupport').checked = c.has_support;
                        toggleSupportSchedule('editSupportScheduleDiv', c.has_support);
                        var sched = c.support_schedule || 'lv';
                        var radio = document.getElementById('editSched_' + sched);
                        if (radio) radio.checked = true;
                    } else {
                        alert('Error al cargar datos del cliente');
                        bootstrap.Modal.getInstance(document.getElementById('modalEditClient')).hide();
                    }
                })
                .catch(function(err) {
                    alert('Error de conexi√≥n al cargar cliente: ' + err.message);
                    bootstrap.Modal.getInstance(document.getElementById('modalEditClient')).hide();
                });
        }

        // Delegaci√≥n de eventos para botones de editar cliente (evita problemas con caracteres especiales)
        document.addEventListener('DOMContentLoaded', function() {
            document.body.addEventListener('click', function(e) {
                var btn = e.target.closest('.edit-client-btn');
                if (btn) {
                    e.preventDefault();
                    var clientId = btn.getAttribute('data-client-id');
                    openEditClientModalFull(clientId);
                }
                var payBtn = e.target.closest('.open-payment-btn');
                if (payBtn) {
                    e.preventDefault();
                    var payId = payBtn.getAttribute('data-pay-id');
                    openPaymentModal(payId);
                }
            });
        });

        // ‚úÖ NUEVO: mostrar/ocultar el selector de horario de soporte
        function toggleSupportSchedule(divId, show) {
            const div = document.getElementById(divId);
            if (div) div.style.display = show ? 'block' : 'none';
        }

        // ‚úÖ NUEVO: Abrir y cargar perfil de t√©cnico
        function openRenameModal(userId, username) {
            document.getElementById('renameUserId').value = userId;
            document.getElementById('renameCurrentUsername').textContent = username;
            document.getElementById('renameNewUsername').value = username;
        }

        function openTechProfileModal(userId, username) {
            document.getElementById('techProfileUserId').value = userId;
            document.getElementById('techProfileUsername').textContent = username;
            document.getElementById('techProfileAlert').classList.add('d-none');

            // Reset campos
            ['tp_full_name','tp_dni','tp_phone','tp_address','tp_emergency_contact',
             'tp_emergency_phone','tp_start_date','tp_internal_notes'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('techProfileUpdatedAt').textContent = '';

            fetch(`/api/tech_profile/${userId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const p = data.profile;
                        const u = data.user;
                        document.getElementById('tp_full_name').value = p.full_name || '';
                        document.getElementById('tp_dni').value = p.dni || '';
                        document.getElementById('tp_phone').value = p.phone || '';
                        document.getElementById('tp_address').value = p.address || '';
                        document.getElementById('tp_emergency_contact').value = p.emergency_contact || '';
                        document.getElementById('tp_emergency_phone').value = p.emergency_phone || '';
                        document.getElementById('tp_start_date').value = p.start_date || '';
                        document.getElementById('tp_email_display').value = u.email || '';
                        document.getElementById('tp_internal_notes').value = p.internal_notes || '';
                        if (p.updated_at) {
                            document.getElementById('techProfileUpdatedAt').textContent = '√öltima actualizaci√≥n: ' + p.updated_at;
                        }
                    }
                })
                .catch(err => console.error('Error cargando perfil t√©cnico:', err));

            new bootstrap.Modal(document.getElementById('modalTechProfile')).show();
        }

        function saveTechProfile() {
            const userId = document.getElementById('techProfileUserId').value;
            const btn = document.getElementById('btnSaveTechProfile');
            const alertDiv = document.getElementById('techProfileAlert');

            const formData = new FormData();
            formData.append('full_name', document.getElementById('tp_full_name').value);
            formData.append('dni', document.getElementById('tp_dni').value);
            formData.append('phone', document.getElementById('tp_phone').value);
            formData.append('address', document.getElementById('tp_address').value);
            formData.append('emergency_contact', document.getElementById('tp_emergency_contact').value);
            formData.append('emergency_phone', document.getElementById('tp_emergency_phone').value);
            formData.append('start_date', document.getElementById('tp_start_date').value);
            formData.append('internal_notes', document.getElementById('tp_internal_notes').value);

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Guardando...';

            fetch(`/api/tech_profile/${userId}`, { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    alertDiv.className = data.success ? 'alert alert-success' : 'alert alert-danger';
                    alertDiv.textContent = data.msg;
                    alertDiv.classList.remove('d-none');
                    if (data.success) {
                        document.getElementById('techProfileUpdatedAt').textContent =
                            '√öltima actualizaci√≥n: ' + new Date().toLocaleString('es-ES');
                    }
                })
                .catch(err => {
                    alertDiv.className = 'alert alert-danger';
                    alertDiv.textContent = 'Error de conexi√≥n al guardar el perfil';
                    alertDiv.classList.remove('d-none');
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-save-fill me-1"></i>Guardar Perfil';
                });
        }

        function openEditServiceModal(id, name, color) {
            document.getElementById('editServiceId').value = id;
            document.getElementById('editServiceName').value = name;
            document.getElementById('editServiceColor').value = color;
            new bootstrap.Modal(document.getElementById('modalEditService')).show();
        }

        // Nueva funci√≥n para editar elementos de stock completos
        function openEditStockItemModal(itemId) {
            fetch(`/api/stock_item/${itemId}`)
                .then(res => res.json())
                .then(response => {
                    if (response.success) {
                        const item = response.data;
                        document.getElementById('editStockItemId').value = item.id;
                        document.getElementById('editStockItemName').value = item.name;
                        document.getElementById('editStockItemQuantity').value = item.quantity;
                        document.getElementById('editStockItemMinStock').value = item.min_stock;
                        document.getElementById('editStockItemSupplier').value = item.supplier || '';
                        document.getElementById('editStockItemDescription').value = item.description || '';
                        document.getElementById('editStockItemCategory').value = item.category_id || '';
                        // ‚úÖ Actualizar la URL de acci√≥n del formulario con el item_id correcto
                        document.getElementById('formEditStockItem').action = `/edit_stock_item/${item.id}`;
                        new bootstrap.Modal(document.getElementById('modalEditStockItem')).show();
                    } else {
                        alert('Error al cargar los datos del art√≠culo');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('Error al cargar el art√≠culo');
                });
        }

        // Nueva funci√≥n para editar categor√≠as de stock
        function openEditCategoryModal(categoryId, categoryName, parentId) {
            document.getElementById('editCategoryId').value = categoryId;
            document.getElementById('editCategoryName').value = categoryName;
            document.getElementById('editCategoryParent').value = parentId || '';
            new bootstrap.Modal(document.getElementById('modalEditCategory')).show();
        }

        function setupAutocomplete(inputId, listId) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            if (!input) return;

            input.addEventListener('input', function () {
                const val = this.value;
                if (!val || val.length < 2) {
                    list.innerHTML = '';
                    list.style.display = 'none';
                    return;
                }
                fetch(`/api/clients_search?q=${encodeURIComponent(val)}`)
                    .then(res => res.json())
                    .then(data => {
                        list.innerHTML = '';
                        if (data.length > 0) {
                            list.style.display = 'block';
                            data.forEach(item => {
                                const div = document.createElement('div');
                                div.className = 'suggestion-item';
                                div.innerText = item.name;
                                div.onclick = function () {
                                    input.value = item.name;
                                    list.innerHTML = '';
                                    list.style.display = 'none';
                                };
                                list.appendChild(div);
                            });
                        } else {
                            list.style.display = 'none';
                        }
                    });
            });

            document.addEventListener('click', function (e) {
                if (e.target !== input && e.target !== list) {
                    list.style.display = 'none';
                }
            });
        }

        function filterClientsView() {
            const input = document.getElementById("clientSearchInput");
            const filter = input.value.toLowerCase();
            const cards = document.querySelectorAll('.client-card-wrapper');

            cards.forEach(card => {
                const name = card.dataset.clientName || '';
                const phone = card.dataset.clientPhone || '';
                const email = card.dataset.clientEmail || '';

                const textContent = (name + ' ' + phone + ' ' + email).toLowerCase();

                if (textContent.indexOf(filter) > -1) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function openEditAdminModal() {
            const taskId = document.getElementById('evtId').value;
            fetch(`/api/get_task/${taskId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('editAdminClientInput').value = data.data.client_name;
                        document.getElementById('editAdminDate').value = data.data.date;
                        document.getElementById('editAdminTime').value = data.data.time;
                        document.getElementById('editAdminService').value = data.data.service_type;
                        document.getElementById('editAdminNotes').value = data.data.notes;
                        document.getElementById('formEditApptAdmin').action = `/edit_appointment/${taskId}`;
                        modalActionAdmin.hide();
                        new bootstrap.Modal(document.getElementById('modalEditAppointmentAdmin')).show();
                        setupAutocomplete('editAdminClientInput', 'editAdminClientList');
                    }
                });
        }

        // Funci√≥n para manejar clic en d√≠a del calendario individual del empleado
        function handleAdminDateClick(info) {
            if (!currentEmployeeId) return;

            // Prellenar el modal con la fecha seleccionada y el empleado actual
            document.getElementById('scheduleClientInput').value = '';
            // Desmarcar todos los checkboxes y marcar el del empleado actual
            document.querySelectorAll('#modalScheduleAppointment .tech-checkbox').forEach(function(cb) {
                cb.checked = (cb.value == currentEmployeeId);
            });
            document.querySelector('#modalScheduleAppointment input[name="date"]').value = info.dateStr;

            // Abrir el modal de nueva cita
            new bootstrap.Modal(document.getElementById('modalScheduleAppointment')).show();
        }

        // Funci√≥n para manejar clic en d√≠a del calendario global
        function handleAdminDateClickGlobal(info) {
            // Prellenar el modal con la fecha seleccionada
            document.getElementById('scheduleClientInput').value = '';
            document.querySelectorAll('#modalScheduleAppointment .tech-checkbox').forEach(function(cb) { cb.checked = false; });
            document.querySelector('#modalScheduleAppointment input[name="date"]').value = info.dateStr;

            // Abrir el modal de nueva cita
            new bootstrap.Modal(document.getElementById('modalScheduleAppointment')).show();
        }

        // Funci√≥n para ver los detalles completos de una tarea
        function viewTaskDetails() {
            const taskId = document.getElementById('evtId').value;

            fetch(`/api/task_details/${taskId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const task = data.data;

                        // Rellenar informaci√≥n b√°sica
                        document.getElementById('detailClient').textContent = task.client_name;
                        document.getElementById('detailTech').textContent = task.tech_name;
                        document.getElementById('detailDate').textContent = task.date || 'N/A';  // ‚úÖ FIX: Mostrar fecha sin conversi√≥n timezone
                        document.getElementById('detailStartTime').textContent = task.start_time || 'N/A';
                        document.getElementById('detailEndTime').textContent = task.end_time || 'N/A';
                        document.getElementById('detailService').textContent = task.service_type;
                        document.getElementById('detailStatus').textContent = task.status;
                        document.getElementById('detailDescription').textContent = task.description || 'Sin descripci√≥n';

                        // Material/Stock
                        if (task.stock_info) {
                            document.getElementById('detailStockSection').style.display = 'block';
                            const action = task.stock_info.action === 'used' ? 'USADO' : 'RETIRADO';
                            document.getElementById('detailStock').textContent =
                                `${action}: ${task.stock_info.quantity}x ${task.stock_info.item_name}`;
                        } else {
                            document.getElementById('detailStockSection').style.display = 'none';
                        }

                        // Notas adicionales
                        if (task.parts_text) {
                            document.getElementById('detailPartsSection').style.display = 'block';
                            document.getElementById('detailParts').textContent = task.parts_text;
                        } else {
                            document.getElementById('detailPartsSection').style.display = 'none';
                        }

                        // Archivos adjuntos
                        if (task.attachments && task.attachments.length > 0) {
                            document.getElementById('detailAttachmentsSection').style.display = 'block';
                            const attachmentsList = document.getElementById('detailAttachmentsList');
                            attachmentsList.innerHTML = '';

                            task.attachments.forEach(filename => {
                                const item = document.createElement('a');
                                item.href = `/uploads/${filename}`;
                                item.target = '_blank';
                                item.className = 'list-group-item list-group-item-action bg-black text-white border-secondary d-flex justify-content-between align-items-center';
                                item.innerHTML = `
                                    <span>
                                        <i class="bi bi-file-earmark-arrow-down me-2"></i>
                                        ${filename}
                                    </span>
                                    <i class="bi bi-download text-warning"></i>
                                `;
                                attachmentsList.appendChild(item);
                            });
                        } else {
                            document.getElementById('detailAttachmentsSection').style.display = 'none';
                        }

                        // Configurar enlace de impresi√≥n
                        document.getElementById('printReportLink').href = `/print_report/${taskId}`;

                        // Cerrar el modal actual y abrir el de detalles
                        modalActionAdmin.hide();
                        new bootstrap.Modal(document.getElementById('modalTaskDetails')).show();
                    } else {
                        alert('Error al cargar los detalles: ' + data.msg);
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('Error al cargar los detalles de la tarea');
                });
        }

        // Modificar handleEventClick para mostrar indicador de archivos adjuntos
        function handleEventClick(info) {
            document.getElementById('evtId').value = info.event.id;
            document.getElementById('evtClient').innerText = info.event.extendedProps.client;
            document.getElementById('evtTech').innerText = info.event.extendedProps.tech_name;
            document.getElementById('evtService').innerText = info.event.extendedProps.service_type;
            document.getElementById('evtStatus').innerText = info.event.extendedProps.status;
            document.getElementById('evtDesc').innerText = info.event.extendedProps.desc || 'Sin descripci√≥n';

            // Mostrar indicador si hay archivos adjuntos
            if (info.event.extendedProps.has_attachments) {
                const attachmentsSection = document.getElementById('attachmentsSection');
                attachmentsSection.style.display = 'block';
                const attachmentsList = document.getElementById('attachmentsList');
                attachmentsList.innerHTML = '<div class="alert alert-info small m-0"><i class="bi bi-paperclip me-1"></i> Esta tarea tiene archivos adjuntos. Haz clic en "Ver Detalles Completos" para acceder a ellos.</div>';
            } else {
                document.getElementById('attachmentsSection').style.display = 'none';
            }

            modalActionAdmin.show();
        }

        // ============================================================
        // FUNCIONES DE ANAL√çTICAS ADMIN
        // ============================================================

        let adminPieChart, adminLineChart, adminBarChart;
        let adminAnalyticsData = null;

        function loadAdminAnalytics() {
            const techId = document.getElementById('analyticsTechSelector').value;
            const period = document.getElementById('analyticsPeriodSelector').value;

            if (!techId) {
                document.getElementById('analyticsPlaceholder').style.display = 'block';
                document.getElementById('analyticsContent').style.display = 'none';
                return;
            }

            // Ocultar placeholder y mostrar contenido
            document.getElementById('analyticsPlaceholder').style.display = 'none';
            document.getElementById('analyticsContent').style.display = 'block';

            // Mostrar indicadores de carga
            document.getElementById('adminTotalServices').textContent = '...';
            document.getElementById('adminTotalMaintenances').textContent = '...';
            document.getElementById('adminTotalRevenue').textContent = '...';
            document.getElementById('adminAvgTime').textContent = '...';

            fetch(`/api/admin_analytics?tech_id=${techId}&period=${period}`)
                .then(res => res.json())
                .then(data => {
                    adminAnalyticsData = data;
                    updateAdminAnalyticsSummary(data);
                    updateAdminServiceDistributionChart(data);
                    updateAdminTimelineChart();
                    updateAdminTopClients(data);
                    updateAdminTopServicesChart(data);
                })
                .catch(err => {
                    console.error('Error cargando anal√≠ticas:', err);
                    alert('Error al cargar las anal√≠ticas');
                });
        }

        function updateAdminAnalyticsSummary(data) {
            document.getElementById('adminTotalServices').textContent = data.total_services || 0;
            document.getElementById('adminTotalMaintenances').textContent = data.total_maintenances || 0;
            document.getElementById('adminTotalRevenue').textContent = (data.total_revenue || 0).toLocaleString('es-ES') + '‚Ç¨';
            document.getElementById('adminAvgTime').textContent = (data.avg_time || 0) + 'h';
        }

        function updateAdminServiceDistributionChart(data) {
            const ctx = document.getElementById('adminServiceDistributionChart');

            if (adminPieChart) {
                adminPieChart.destroy();
            }

            const distribution = data.service_distribution || {};
            const labels = Object.keys(distribution);
            const values = Object.values(distribution);

            const colors = [
                '#f37021', '#4bc0c0', '#ff6384', '#36a2eb', '#ffcd56',
                '#9966ff', '#ff9f40', '#4dc9f6', '#f67019', '#8549ba'
            ];

            adminPieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: '#161616',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#ffffff',
                                padding: 15,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateAdminTimelineChart() {
            const ctx = document.getElementById('adminTimelineChart');
            const metric = document.getElementById('adminMetricSelector').value;

            if (adminLineChart) {
                adminLineChart.destroy();
            }

            if (!adminAnalyticsData || !adminAnalyticsData.timeline) {
                return;
            }

            const timeline = adminAnalyticsData.timeline;
            const labels = timeline.map(t => t.date);
            let data, label, color;

            if (metric === 'services') {
                data = timeline.map(t => t.services);
                label = 'Servicios Realizados';
                color = '#4bc0c0';
            } else if (metric === 'revenue') {
                data = timeline.map(t => t.revenue);
                label = 'Ingresos (‚Ç¨)';
                color = '#36a2eb';
            } else if (metric === 'maintenances') {
                data = timeline.map(t => t.maintenances);
                label = 'Mantenimientos';
                color = '#ffcd56';
            }

            adminLineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: color,
                        backgroundColor: color + '33',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#aaaaaa' },
                            grid: { color: '#333333' }
                        },
                        x: {
                            ticks: { color: '#aaaaaa' },
                            grid: { color: '#333333' }
                        }
                    }
                }
            });
        }

        function updateAdminTopClients(data) {
            const container = document.getElementById('adminTopClients');
            const topClients = data.top_clients || [];

            if (topClients.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                        No hay datos disponibles
                    </div>
                `;
                return;
            }

            container.innerHTML = topClients.map((client, index) => `
                <div class="list-group-item bg-dark border-secondary text-white d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <span class="badge bg-info me-2">${index + 1}</span>
                        <strong>${client.name}</strong>
                    </div>
                    <span class="badge bg-warning text-dark">${client.count} servicios</span>
                </div>
            `).join('');
        }

        function updateAdminTopServicesChart(data) {
            const ctx = document.getElementById('adminTopServicesChart');

            if (adminBarChart) {
                adminBarChart.destroy();
            }

            const topServices = data.top_services || {};
            const labels = Object.keys(topServices);
            const values = Object.values(topServices);

            adminBarChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cantidad',
                        data: values,
                        backgroundColor: '#f37021',
                        borderColor: '#f37021',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { color: '#aaaaaa' },
                            grid: { color: '#333333' }
                        },
                        y: {
                            ticks: { color: '#aaaaaa' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // ==================== GESTI√ìN DE CATEGOR√çAS DE STOCK ====================

        function toggleParentSelect() {
            const type = document.getElementById('categoryType').value;
            const parentDiv = document.getElementById('parentCategoryDiv');
            const parentSelect = document.getElementById('parentCategorySelect');

            if (type === 'sub') {
                parentDiv.style.display = 'block';
                parentSelect.required = true;
                loadMainCategoriesForParent();
            } else {
                parentDiv.style.display = 'none';
                parentSelect.required = false;
                parentSelect.value = '';
            }
        }

        // Manejar env√≠o del formulario de categor√≠as con AJAX
        document.getElementById('categoryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const type = document.getElementById('categoryType').value;
            const parentId = document.getElementById('parentCategorySelect').value;

            if (type === 'sub' && !parentId) {
                alert('Por favor, selecciona una categor√≠a padre para la subcategor√≠a');
                return;
            }

            const formData = new FormData(this);
            
            fetch('/manage_stock_categories', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert(data.msg || 'Categor√≠a creada correctamente');
                    loadCategoriesTree();
                    bootstrap.Modal.getInstance(document.getElementById('modalAddCategory')).hide();
                    this.reset();
                    document.getElementById('parentCategoryDiv').style.display = 'none';
                } else {
                    alert('Error: ' + (data.msg || 'Error desconocido'));
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Error al crear la categor√≠a');
            });
        });

        function loadMainCategoriesForParent() {
            fetch('/api/stock_categories')
                .then(res => res.json())
                .then(data => {
                    const select = document.getElementById('parentCategorySelect');
                    select.innerHTML = '<option value="">-- Seleccionar --</option>';

                    data.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = cat.name;
                        select.appendChild(option);
                    });
                })
                .catch(err => console.error('Error cargando categor√≠as:', err));
        }

        function loadCategoriesTree() {
            fetch('/api/stock_categories')
                .then(res => res.json())
                .then(data => {
                    updateCategoriesTreeView(data);
                    updateCategorySelectors(data);
                })
                .catch(err => {
                    console.error('Error:', err);
                    document.getElementById('categoriesTree').innerHTML =
                        '<div class="text-center text-danger py-3"><i class="bi bi-exclamation-triangle me-2"></i>Error cargando categor√≠as</div>';
                });
        }

        function updateCategoriesTreeView(categories) {
            const container = document.getElementById('categoriesTree');
            if (!container) return;

            if (categories.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-3"><i class="bi bi-inbox me-2"></i>No hay categor√≠as creadas</div>';
                return;
            }

            let html = '<div class="list-group">';
            categories.forEach(cat => {
                html += buildCategoryTreeHTML(cat, 0);
            });
            html += '</div>';

            container.innerHTML = html;
        }

        function buildCategoryTreeHTML(cat, level) {
            const indent = level * 20;
            const hasChildren = cat.children && cat.children.length > 0;
            const icon = hasChildren ? 'folder-fill' : 'folder2';
            const itemCount = cat.items ? cat.items.length : 0;

            let html = `
                <div class="list-group-item bg-dark border-secondary mb-2" style="margin-left: ${indent}px;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-${icon} text-warning me-2"></i>
                            <strong class="text-white">${cat.name}</strong>
                            <span class="badge bg-info ms-2">${itemCount} productos</span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-success me-1" onclick="addSubcategoryTo(${cat.id}, '${cat.name}')" title="A√±adir subcategor√≠a">
                                <i class="bi bi-plus-circle"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory(${cat.id}, '${cat.name}', ${itemCount})" title="Eliminar">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            if (hasChildren) {
                cat.children.forEach(child => {
                    html += buildCategoryTreeHTML(child, level + 1);
                });
            }

            return html;
        }

        function addSubcategoryTo(parentId, parentName) {
            document.getElementById('categoryType').value = 'sub';
            toggleParentSelect();

            // ‚úÖ CORRECCI√ìN: preseleccionar despu√©s de que loadMainCategoriesForParent termine
            fetch('/api/stock_categories')
                .then(res => res.json())
                .then(data => {
                    const select = document.getElementById('parentCategorySelect');
                    select.innerHTML = '<option value="">-- Seleccionar --</option>';
                    data.forEach(cat => {
                        const opt = document.createElement('option');
                        opt.value = cat.id;
                        opt.textContent = cat.name;
                        select.appendChild(opt);
                    });
                    select.value = String(parentId); // preseleccionar correctamente
                })
                .catch(err => console.error('Error cargando categor√≠as padre:', err));

            const modal = new bootstrap.Modal(document.getElementById('modalAddCategory'));
            modal.show();
            document.getElementById('categoryName').placeholder = `Nueva subcategor√≠a de ${parentName}`;
        }

        // ‚úÖ NUEVO: Cargar categor√≠as cuando se abre el modal de a√±adir stock
        document.getElementById('modalAddStock').addEventListener('show.bs.modal', function () {
            loadCategoriesIntoAddStockSelect();
        });

        function loadCategoriesIntoAddStockSelect() {
            fetch('/api/stock_categories')
                .then(res => res.json())
                .then(data => {
                    const select = document.getElementById('addStockCategory');
                    select.innerHTML = '<option value="">-- Seleccionar Categor√≠a --</option>';
                    addCategoryOptionsToSelect(select, data);
                    // Ocultar subcategor√≠a al recargar
                    document.getElementById('subcategorySection').style.display = 'none';
                    document.getElementById('addStockSubcategory').innerHTML = '<option value="">-- Sin subcategor√≠a --</option>';
                })
                .catch(err => console.error('Error cargando categor√≠as en modal:', err));
        }

        // ‚úÖ NUEVO: Manejador AJAX del formulario de a√±adir stock
        document.getElementById('formAddStock').addEventListener('submit', function(e) {
            e.preventDefault();
            const btn = document.getElementById('btnAddStockSubmit');
            const alertDiv = document.getElementById('addStockAlert');

            // Validaci√≥n b√°sica frontend
            const name = document.getElementById('addStockName').value.trim();
            const catId = document.getElementById('addStockCategory').value;
            if (!name) {
                alertDiv.className = 'alert alert-danger';
                alertDiv.textContent = 'El nombre del producto es obligatorio';
                alertDiv.classList.remove('d-none');
                return;
            }
            if (!catId) {
                alertDiv.className = 'alert alert-danger';
                alertDiv.textContent = 'Debes seleccionar una categor√≠a';
                alertDiv.classList.remove('d-none');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>A√±adiendo...';

            const formData = new FormData(this);
            formData.append('action', 'add');

            fetch('/manage_stock', { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alertDiv.className = 'alert alert-success';
                        alertDiv.textContent = data.msg;
                        alertDiv.classList.remove('d-none');
                        this.reset();
                        document.getElementById('subcategorySection').style.display = 'none';
                        loadStockTree();
                        loadCategoriesIntoAddStockSelect();
                        setTimeout(() => {
                            bootstrap.Modal.getInstance(document.getElementById('modalAddStock')).hide();
                            alertDiv.classList.add('d-none');
                        }, 1200);
                    } else {
                        alertDiv.className = 'alert alert-danger';
                        alertDiv.textContent = 'Error: ' + (data.msg || 'Error desconocido');
                        alertDiv.classList.remove('d-none');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alertDiv.className = 'alert alert-danger';
                    alertDiv.textContent = 'Error de conexi√≥n al a√±adir el producto';
                    alertDiv.classList.remove('d-none');
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-plus-circle-fill me-1"></i>A√±adir Producto';
                });
        });

        function deleteCategory(id, name, itemCount) {
            if (itemCount > 0) {
                if (!confirm(`La categor√≠a "${name}" tiene ${itemCount} productos. ¬øEst√°s seguro de eliminarla? Los productos NO se eliminar√°n.`)) {
                    return;
                }
            } else {
                if (!confirm(`¬øEliminar la categor√≠a "${name}"?`)) {
                    return;
                }
            }

            const formData = new FormData();
            formData.append('action', 'delete');
            formData.append('category_id', id);

            fetch('/manage_stock_categories', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        loadCategoriesTree();
                        alert('Categor√≠a eliminada correctamente');
                    } else {
                        alert('Error al eliminar: ' + (data.msg || 'Error desconocido'));
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('Error al eliminar categor√≠a');
                });
        }

        function updateCategorySelectors(categories) {
            // Actualizar selector en modal de a√±adir stock
            const addStockSelect = document.getElementById('addStockCategory');
            if (addStockSelect) {
                addStockSelect.innerHTML = '<option value="">-- Seleccionar Categor√≠a --</option>';
                addCategoryOptionsToSelect(addStockSelect, categories);
            }
        }

        function addCategoryOptionsToSelect(select, categories, prefix = '') {
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = prefix + cat.name;
                option.dataset.hasChildren = cat.children && cat.children.length > 0;
                select.appendChild(option);

                // No a√±adir subcategor√≠as aqu√≠, se cargar√°n din√°micamente
            });
        }

        function loadSubcategories(categoryId, targetSelectId) {
            const subcategorySection = document.getElementById('subcategorySection');
            const subcategorySelect = document.getElementById(targetSelectId);

            if (!categoryId) {
                subcategorySection.style.display = 'none';
                return;
            }

            fetch('/api/stock_categories')
                .then(res => res.json())
                .then(data => {
                    const category = findCategoryById(data, parseInt(categoryId));

                    if (category && category.children && category.children.length > 0) {
                        subcategorySection.style.display = 'block';
                        subcategorySelect.innerHTML = '<option value="">-- Sin subcategor√≠a --</option>';

                        category.children.forEach(sub => {
                            const option = document.createElement('option');
                            option.value = sub.id;
                            option.textContent = sub.name;
                            subcategorySelect.appendChild(option);
                        });
                    } else {
                        subcategorySection.style.display = 'none';
                        subcategorySelect.innerHTML = '<option value="">-- Sin subcategor√≠a --</option>';
                    }
                })
                .catch(err => console.error('Error cargando subcategor√≠as:', err));
        }

        function findCategoryById(categories, id) {
            for (let cat of categories) {
                if (cat.id === id) return cat;
                if (cat.children) {
                    const found = findCategoryById(cat.children, id);
                    if (found) return found;
                }
            }
            return null;
        }

        // ==================== FUNCIONES DE SOPORTE T√âCNICO ====================

        // ==================== GOOGLE MAPS ====================

        document.getElementById('clientAddress')?.addEventListener('input', function () {
            const address = this.value.trim();
            const link = document.getElementById('openGoogleMaps');

            if (address) {
                const encoded = encodeURIComponent(address);
                link.href = `https://www.google.com/maps/search/?api=1&query=${encoded}`;
                link.style.display = 'block';
            } else {
                link.style.display = 'none';
            }
        });

        // ==================== ESTAD√çSTICAS GLOBALES ====================

        let taskTypesPieChart = null;

        function toggleCustomDateFields() {
            const period = document.getElementById('statsFilterPeriod').value;
            const fromField = document.getElementById('customDateFromField');
            const toField = document.getElementById('customDateToField');
            
            if (period === 'custom') {
                fromField.style.display = 'block';
                toField.style.display = 'block';
            } else {
                fromField.style.display = 'none';
                toField.style.display = 'none';
            }
        }

        function loadAdminStatistics() {
            const techId = document.getElementById('statsFilterTech').value;
            const period = document.getElementById('statsFilterPeriod').value;

            let url = '/api/admin_analytics?';
            if (techId) url += `tech_id=${techId}&`;
            if (period && period !== 'custom') {
                url += `period=${period}`;
            } else if (period === 'custom') {
                const dateFrom = document.getElementById('statsDateFrom').value;
                const dateTo = document.getElementById('statsDateTo').value;
                if (dateFrom && dateTo) {
                    url = `/api/admin_analytics?tech_id=${techId || ''}&period=custom&from=${dateFrom}&to=${dateTo}`;
                } else {
                    alert('‚ö†Ô∏è Por favor selecciona ambas fechas');
                    return;
                }
            }

            fetch(url)
                .then(res => res.json())
                .then(response => {
                    if (response.success) {
                        const data = response.data;

                        // Actualizar KPIs
                        document.getElementById('kpiTotalTasks').textContent = data.total_tasks;
                        document.getElementById('kpiCompletedTasks').textContent = data.completed_tasks;
                        document.getElementById('kpiPendingTasks').textContent = data.pending_tasks;
                        document.getElementById('kpiActiveTechs').textContent = data.active_technicians;

                        // Crear gr√°fico circular de tipos de tareas
                        createTaskTypesPieChart(data.task_types);
                    } else {
                        alert('Error al cargar estad√≠sticas: ' + response.msg);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al conectar con el servidor');
                });
        }

        function createTaskTypesPieChart(taskTypes) {
            const canvas = document.getElementById('taskTypesPieChart');
            const noDataDiv = document.getElementById('noPieData');

            // Si no hay datos
            if (!taskTypes || Object.keys(taskTypes).length === 0) {
                canvas.style.display = 'none';
                noDataDiv.style.display = 'block';
                return;
            }

            canvas.style.display = 'block';
            noDataDiv.style.display = 'none';

            // Preparar datos
            const labels = [];
            const counts = [];
            const colors = [];

            for (const [name, info] of Object.entries(taskTypes)) {
                labels.push(name);
                counts.push(info.count);
                colors.push(info.color);
            }

            // Destruir gr√°fico anterior si existe
            if (taskTypesPieChart) {
                taskTypesPieChart.destroy();
            }

            // Crear nuevo gr√°fico
            const ctx = canvas.getContext('2d');
            taskTypesPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors,
                        borderColor: '#1e1e1e',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#fff',
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const percentage = taskTypes[label].percentage || 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }


        // ==================== INICIALIZACI√ìN ====================

        document.addEventListener('DOMContentLoaded', function () {
            // Cargar categor√≠as al inicio
            loadCategoriesTree();

            // Recargar cuando se abre el modal de a√±adir stock
            const modalAddStock = document.getElementById('modalAddStock');
            if (modalAddStock) {
                modalAddStock.addEventListener('show.bs.modal', function () {
                    loadCategoriesTree();
                });
            }
        });


        // ==================== ANAL√çTICAS POR T√âCNICO ====================

        function viewTechStats(techId) {
            const modal = new bootstrap.Modal(document.getElementById('modalTechStats'));
            modal.show();

            document.getElementById('techStatsContent').innerHTML = `
                <div class="text-center text-muted py-5">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-3">Cargando estad√≠sticas...</p>
                </div>
            `;

            fetch(`/api/tech_stats/${techId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        displayTechStats(data.data);
                    } else {
                        document.getElementById('techStatsContent').innerHTML = `
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Error al cargar las estad√≠sticas
                            </div>
                        `;
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    document.getElementById('techStatsContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Error de conexi√≥n
                        </div>
                    `;
                });
        }

        function displayTechStats(data) {
            const container = document.getElementById('techStatsContent');

            let html = `
                <div class="mb-4">
                    <h5 class="text-white fw-bold">
                        <i class="bi bi-person-circle me-2 text-warning"></i>
                        ${data.tech_name}
                    </h5>
                </div>
                
                <div class="row g-3 mb-4">
                    <div class="col-6">
                        <div class="card bg-dark border-secondary p-3 text-center">
                            <h3 class="text-success fw-bold mb-0">${data.total_completed}</h3>
                            <small class="text-muted">Servicios Completados</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-dark border-secondary p-3 text-center">
                            <h3 class="text-info fw-bold mb-0">${data.total_hours}h</h3>
                            <small class="text-muted">Horas Trabajadas</small>
                        </div>
                    </div>
                </div>
                
                <div class="card bg-dark border-secondary p-3">
                    <h6 class="text-white fw-bold mb-3">
                        <i class="bi bi-bar-chart me-2"></i>Desglose por Tipo de Servicio
                    </h6>
            `;

            for (const [serviceName, serviceData] of Object.entries(data.service_breakdown)) {
                html += `
                    <div class="mb-3 pb-3 border-bottom border-secondary">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong class="text-warning">${serviceName}</strong>
                            <span class="badge bg-info">${serviceData.count} servicios</span>
                        </div>
                        <div class="small text-muted">
                            ${serviceData.tasks.slice(0, 3).map(task => `
                                <div class="d-flex justify-content-between py-1">
                                    <span>${task.client}</span>
                                    <span>${task.date}</span>
                                </div>
                            `).join('')}
                            ${serviceData.tasks.length > 3 ? `<div class="text-center pt-2"><small>... y ${serviceData.tasks.length - 3} m√°s</small></div>` : ''}
                        </div>
                    </div>
                `;
            }

            html += `</div>`;
            container.innerHTML = html;
        }

        // ==================== VISTA JER√ÅRQUICA DE STOCK ====================

        function loadStockTree() {
            const container = document.getElementById('stockCategoriesTree');
            container.innerHTML = '<div class="text-center text-muted py-3"><i class="bi bi-hourglass-split"></i> Cargando...</div>';

            fetch('/api/stock_categories')
                .then(res => res.json())
                .then(data => {
                    updateStockTreeView(data);
                })
                .catch(err => {
                    console.error('Error:', err);
                    container.innerHTML = `
                        <div class="text-center text-danger py-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Error cargando inventario
                        </div>
                    `;
                });
        }

        function updateStockTreeView(categories) {
            const container = document.getElementById('stockCategoriesTree');

            if (categories.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-3"><i class="bi bi-inbox me-2"></i>No hay categor√≠as creadas</div>';
                return;
            }

            let html = '<div class="list-group">';
            categories.forEach(cat => {
                html += buildStockCategoryTreeHTML(cat, 0);
            });
            html += '</div>';

            container.innerHTML = html;
        }

        function buildStockCategoryTreeHTML(cat, level) {
            const indent = level * 20;
            const hasChildren = cat.children && cat.children.length > 0;
            const hasItems = cat.items && cat.items.length > 0;
            const icon = hasChildren ? 'folder-fill' : 'folder2';
            const itemCount = cat.items ? cat.items.length : 0;
            const categoryId = `cat_${cat.id}_${level}`;
            const itemsId = `items_${cat.id}_${level}`;

            let html = `
                <div class="list-group-item bg-dark border-secondary mb-2" style="margin-left: ${indent}px;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="flex-grow-1">
                            ${(hasChildren || hasItems) ? `
                                <button class="btn btn-sm btn-link text-white p-0 me-2" 
                                        onclick="toggleStockSection('${categoryId}', '${itemsId}', this)"
                                        title="Expandir/Colapsar">
                                    <i class="bi bi-chevron-right" id="icon_${categoryId}" style="transition: transform 0.3s;"></i>
                                </button>
                            ` : ''}
                            <i class="bi bi-${icon} text-warning me-2"></i>
                            <strong class="text-white">${cat.name}</strong>
                            <span class="badge bg-info ms-2">${itemCount} productos</span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-warning me-1" 
                                    onclick="openEditCategoryModal(${cat.id}, '${cat.name.replace(/'/g, "\\'")}', ${cat.parent_id || 'null'})"
                                    title="Editar categor√≠a">
                                <i class="bi bi-pencil-fill"></i>
                            </button>
                        </div>
                    </div>
            `;

            // Productos de esta categor√≠a
            if (hasItems) {
                html += `<div id="${itemsId}" class="mt-2" style="margin-left: 30px; display: none;">`;
                cat.items.forEach(item => {
                    const stockBadgeClass = item.quantity <= item.min_stock ? 'bg-danger' : 'bg-success';
                    const supplierText = item.supplier ? `<small class="text-muted">(${item.supplier})</small>` : '';
                    html += `
                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom border-secondary">
                            <div>
                                <i class="bi bi-box text-info me-2"></i>
                                <span class="text-white">${item.name}</span> ${supplierText}
                                <span class="badge ${stockBadgeClass} ms-2">${item.quantity}</span>
                                ${item.min_stock ? `<small class="text-muted">(Min: ${item.min_stock})</small>` : ''}
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-success me-1" 
                                        onclick="ajustarStock(${item.id}, '${item.name.replace(/'/g, "\\'")}', ${item.quantity})"
                                        title="Ajustar cantidad">
                                    <i class="bi bi-arrow-repeat"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning me-1" 
                                        onclick="openEditStockItemModal(${item.id})"
                                        title="Editar art√≠culo">
                                    <i class="bi bi-pencil-fill"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="deleteStockItem(${item.id}, '${item.name.replace(/'/g, "\\'")}')">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            html += '</div>';

            // Subcategor√≠as
            if (hasChildren) {
                html += `<div id="${categoryId}" style="display: none;">`;
                cat.children.forEach(child => {
                    html += buildStockCategoryTreeHTML(child, level + 1);
                });
                html += '</div>';
            }

            return html;
        }

        // Funci√≥n para expandir/colapsar secciones de stock
        function toggleStockSection(categoryId, itemsId, button) {
            const categoryDiv = document.getElementById(categoryId);
            const itemsDiv = document.getElementById(itemsId);
            const icon = document.getElementById('icon_' + categoryId);

            // Alternar visibilidad
            if (categoryDiv) {
                const isHidden = categoryDiv.style.display === 'none';
                categoryDiv.style.display = isHidden ? 'block' : 'none';
            }

            if (itemsDiv) {
                const isHidden = itemsDiv.style.display === 'none';
                itemsDiv.style.display = isHidden ? 'block' : 'none';
            }

            // Rotar icono
            if (icon) {
                if (icon.style.transform === 'rotate(90deg)') {
                    icon.style.transform = 'rotate(0deg)';
                } else {
                    icon.style.transform = 'rotate(90deg)';
                }
            }
        }

        function deleteStockItem(itemId, itemName) {
            if (!confirm(`¬øEliminar el producto "${itemName}"?`)) return;

            const formData = new FormData();
            formData.append('action', 'delete');
            formData.append('item_id', itemId);

            fetch('/manage_stock', {
                method: 'POST',
                body: formData
            })
                .then(() => {
                    loadStockTree();
                    alert('Producto eliminado correctamente');
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('Error al eliminar el producto');
                });
        }

        // Event listeners para cargar stock tree y categories tree al abrir las pesta√±as
        document.addEventListener('DOMContentLoaded', function () {
            const stockTabButton = document.querySelector('button[data-bs-target="#stock"]');
            if (stockTabButton) {
                stockTabButton.addEventListener('click', function () {
                    setTimeout(() => loadStockTree(), 100);
                });
            }

            const configTabButton = document.querySelector('button[data-bs-target="#config"]');
            if (configTabButton) {
                configTabButton.addEventListener('click', function () {
                    setTimeout(() => loadCategoriesTree(), 100);
                });
            }
        });

        // ==================== GESTI√ìN DE STOCK MEJORADA ====================

        // NOTA: La carga de categor√≠as en modalAddStock se gestiona arriba con loadCategoriesIntoAddStockSelect()
        // que soporta correctamente subcategor√≠as din√°micas.

        function loadCategoriesForStockForm(prefix) {
            const select = document.getElementById(prefix + 'Category');
            if (!select) return;

            select.innerHTML = '<option value="">Cargando...</option>';

            fetch('/api/stock_categories')
                .then(res => res.json())
                .then(categories => {
                    let options = '<option value="">-- Seleccionar --</option>';

                    function addCategories(cats, pref = '') {
                        cats.forEach(cat => {
                            options += `<option value="${cat.id}">${pref}${cat.name}</option>`;
                            if (cat.children && cat.children.length > 0) {
                                addCategories(cat.children, pref + '‚Üí ');
                            }
                        });
                    }

                    addCategories(categories);
                    select.innerHTML = options;
                });
        }

        function editStockItem(itemId) {
            fetch(`/api/stock_item/${itemId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const item = data.data;

                        // Crear modal si no existe
                        let modal = document.getElementById('modalEditStockComplete');
                        if (!modal) {
                            const modalHTML = `
                                <div class="modal fade" id="modalEditStockComplete" tabindex="-1">
                                    <div class="modal-dialog">
                                        <div class="modal-content bg-dark text-white">
                                            <div class="modal-header border-secondary">
                                                <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Editar Art√≠culo</h5>
                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                            </div>
                                            <form id="formEditStockComplete">
                                                <div class="modal-body">
                                                    <input type="hidden" id="editStockIdComplete">
                                                    <div class="mb-3">
                                                        <label class="form-label">Nombre *</label>
                                                        <input type="text" id="editStockNameComplete" class="form-control" required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Categor√≠a *</label>
                                                        <select id="editStockCategoryComplete" class="form-select" required></select>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6 mb-3">
                                                            <label class="form-label">Stock Actual</label>
                                                            <input type="number" id="editStockQtyComplete" class="form-control" readonly>
                                                            <small class="text-muted">Use Ajustar para modificar</small>
                                                        </div>
                                                        <div class="col-md-6 mb-3">
                                                            <label class="form-label">Stock M√≠nimo *</label>
                                                            <input type="number" id="editStockMinComplete" class="form-control" required min="1">
                                                        </div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Proveedor *</label>
                                                        <input type="text" id="editStockSupplierComplete" class="form-control" required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Descripci√≥n</label>
                                                        <textarea id="editStockDescComplete" class="form-control" rows="2"></textarea>
                                                    </div>
                                                </div>
                                                <div class="modal-footer border-secondary">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                                    <button type="submit" class="btn btn-warning"><i class="bi bi-check-circle me-1"></i>Guardar</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            `;
                            document.body.insertAdjacentHTML('beforeend', modalHTML);

                            // A√±adir event listener al formulario
                            document.getElementById('formEditStockComplete').addEventListener('submit', function (e) {
                                e.preventDefault();

                                const formData = new FormData();
                                formData.append('action', 'edit');
                                formData.append('item_id', document.getElementById('editStockIdComplete').value);
                                formData.append('name', document.getElementById('editStockNameComplete').value);
                                formData.append('min_stock', document.getElementById('editStockMinComplete').value);
                                formData.append('supplier', document.getElementById('editStockSupplierComplete').value);
                                formData.append('category_id', document.getElementById('editStockCategoryComplete').value);

                                fetch('/manage_stock', {
                                    method: 'POST',
                                    body: formData
                                })
                                    .then(res => res.json())
                                    .then(data => {
                                        if (data.success) {
                                            bootstrap.Modal.getInstance(document.getElementById('modalEditStockComplete')).hide();
                                            loadStockTree();
                                            alert('‚úì Art√≠culo actualizado');
                                        } else {
                                            alert('Error: ' + data.msg);
                                        }
                                    });
                            });
                        }

                        // Rellenar datos
                        document.getElementById('editStockIdComplete').value = item.id;
                        document.getElementById('editStockNameComplete').value = item.name;
                        document.getElementById('editStockQtyComplete').value = item.quantity;
                        document.getElementById('editStockMinComplete').value = item.min_stock;
                        document.getElementById('editStockSupplierComplete').value = item.supplier || '';
                        document.getElementById('editStockDescComplete').value = item.description || '';

                        // Cargar categor√≠as
                        const select = document.getElementById('editStockCategoryComplete');
                        fetch('/api/stock_categories')
                            .then(res => res.json())
                            .then(categories => {
                                let options = '<option value="">-- Seleccionar --</option>';
                                function addCats(cats, pref = '') {
                                    cats.forEach(cat => {
                                        const sel = cat.id == item.category_id ? 'selected' : '';
                                        options += `<option value="${cat.id}" ${sel}>${pref}${cat.name}</option>`;
                                        if (cat.children && cat.children.length > 0) {
                                            addCats(cat.children, pref + '‚Üí ');
                                        }
                                    });
                                }
                                addCats(categories);
                                select.innerHTML = options;
                            });

                        new bootstrap.Modal(document.getElementById('modalEditStockComplete')).show();
                    }
                });
        }

        // Actualizar calendario despu√©s de agendar
        const formSchedule = document.querySelector('#modalScheduleAppointment form');
        if (formSchedule && !formSchedule.hasAttribute('data-enhanced')) {
            formSchedule.setAttribute('data-enhanced', 'true');
            formSchedule.addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(this);
                fetch('/schedule_appointment', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (response.ok) {
                            bootstrap.Modal.getInstance(document.getElementById('modalScheduleAppointment')).hide();
                            if (window.calendarGlobalInstance) window.calendarGlobalInstance.refetchEvents();
                            if (window.calendar) window.calendar.refetchEvents();
                            alert('‚úì Cita agendada');
                            this.reset();
                            location.reload();
                        }
                    });
            });
        }

        // FUNCI√ìN PARA MOSTRAR ARCHIVOS ADJUNTOS EN INFORMES
        function showAttachmentsModal(taskId, clientName) {
            const container = document.getElementById('attachmentsListContainer');
            container.innerHTML = '<div class="text-center text-muted py-3"><i class="bi bi-hourglass-split me-2"></i>Cargando archivos...</div>';
            document.getElementById('attachModalClient').innerText = clientName;

            // Abrir modal inmediatamente mientras carga
            const modal = new bootstrap.Modal(document.getElementById('modalAttachments'));
            modal.show();

            fetch(`/api/task/${taskId}/attachments`)
                .then(function(res) {
                    if (!res.ok) throw new Error('Error ' + res.status);
                    return res.json();
                })
                .then(function(data) {
                    if (!data.success || !data.attachments || data.attachments.length === 0) {
                        container.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-inbox fs-1 d-block mb-2"></i>No hay archivos adjuntos</div>';
                        return;
                    }

                    let html = '';
                    data.attachments.forEach(function(att) {
                        // Soportar formato string o {filename, original_name, size}
                        var filename = typeof att === 'object' ? (att.filename || att.name || att) : att;
                        var originalName = typeof att === 'object' ? (att.original_name || att.name || filename) : att;
                        var sizeKB = (att.size && att.size > 0) ? (att.size / 1024).toFixed(1) + ' KB' : '';

                        // Escapar comillas para uso seguro en onclick
                        var safeFilename = filename.replace(/'/g, "\\'");
                        var safeName = originalName.replace(/'/g, "\\'");

                        html += `
                            <div class="d-flex justify-content-between align-items-center p-3 mb-2 rounded"
                                 style="background:#1f1f1f; border:1px solid #444;">
                                <div>
                                    <i class="bi bi-file-earmark-fill text-info me-2"></i>
                                    <strong class="text-white">${originalName}</strong>
                                    ${sizeKB ? '<br><small class="text-muted ms-4">' + sizeKB + '</small>' : ''}
                                </div>
                                <div class="d-flex gap-2 ms-3">
                                    <a href="/uploads/${filename}" target="_blank" rel="noopener noreferrer"
                                       class="btn btn-sm btn-info">
                                        <i class="bi bi-eye me-1"></i>Ver
                                    </a>
                                    <a href="/uploads/${filename}" download="${originalName}"
                                       class="btn btn-sm btn-success">
                                        <i class="bi bi-download me-1"></i>Descargar
                                    </a>
                                </div>
                            </div>`;
                    });
                    container.innerHTML = html;
                })
                .catch(function(err) {
                    container.innerHTML = '<div class="text-center text-danger py-3"><i class="bi bi-exclamation-triangle me-2"></i>Error al cargar archivos: ' + err.message + '</div>';
                });
        }

        // Ver archivo en nueva pesta√±a
        function viewFile(url, filename, evt) {
            if (evt) evt.preventDefault();
            window.open(url, '_blank', 'noopener,noreferrer');
        }

        // Descargar archivo directamente sin fetch HEAD previo
        function downloadFile(url, filename, evt) {
            if (evt) evt.preventDefault();
            var link = document.createElement('a');
            link.href = url;
            link.download = filename || 'archivo';
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }


        // =====================================================================
        // M√ìDULO PAGOS ‚Äî carga siempre desde el servidor (misma BD que Clientes)
        // =====================================================================
        let _allPaymentsData = [];
        let _currentPayFilter = 'all';
        let _paymentsLoaded = false;

        // Se llama al hacer clic en la pesta√±a PAGOS
        function loadPaymentsList() {
            // Siempre recarga para reflejar clientes nuevos o eliminados
            _paymentsLoaded = false;
            const container = document.getElementById('paymentsListContainer');
            if (container) {
                container.innerHTML = '<div class="col-12 text-center text-muted py-5"><div class="spinner-border spinner-border-sm me-2"></div>Cargando clientes...</div>';
            }
            fetch('/api/payments/summary')
                .then(function(res) {
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    return res.json();
                })
                .then(function(data) {
                    if (data.success) {
                        _allPaymentsData = data.data;
                        _paymentsLoaded = true;
                        renderPaymentList();
                        var countEl = document.getElementById('pagosTotalCount');
                        if (countEl) countEl.innerText = _allPaymentsData.length + ' clientes';
                    } else {
                        throw new Error(data.msg || 'Error desconocido');
                    }
                })
                .catch(function(err) {
                    var container = document.getElementById('paymentsListContainer');
                    if (container) {
                        container.innerHTML = '<div class="col-12 text-center text-danger py-5"><i class="bi bi-exclamation-triangle me-2"></i>Error al cargar: ' + err.message + '</div>';
                    }
                    console.error('Error loadPaymentsList:', err);
                });
        }

        function filterPayments(filter) {
            _currentPayFilter = filter;
            // Reset button styles
            var btnAll = document.getElementById('payFilterAll');
            var btnPend = document.getElementById('payFilterPending');
            var btnPaid = document.getElementById('payFilterPaid');
            if (btnAll) { btnAll.className = 'btn btn-sm ' + (filter === 'all' ? 'btn-light' : 'btn-outline-light'); }
            if (btnPend) { btnPend.style.opacity = filter === 'pending' ? '1' : '0.55'; }
            if (btnPaid) { btnPaid.style.opacity = filter === 'paid' ? '1' : '0.55'; }
            renderPaymentList();
        }

        function renderPaymentList() {
            var container = document.getElementById('paymentsListContainer');
            if (!container) return;
            if (!_paymentsLoaded) return;

            var searchVal = (document.getElementById('paySearchInput') ? document.getElementById('paySearchInput').value : '').toLowerCase().trim();
            var hasSearch = searchVal.length > 0;

            // Sin b√∫squeda: solo clientes con pagos (paid/pending). Con b√∫squeda: todos los clientes
            var filtered = _allPaymentsData.filter(function(c) {
                var nameMatch = c.name.toLowerCase().indexOf(searchVal) >= 0 || c.phone.indexOf(searchVal) >= 0;
                if (!nameMatch) return false;
                if (!hasSearch && c.status === 'none') return false; // Ocultar sin pagos si no hay b√∫squeda
                if (_currentPayFilter === 'all') return true;
                return c.status === _currentPayFilter;
            });

            var countEl = document.getElementById('pagosTotalCount');
            if (countEl) countEl.innerText = filtered.length + (hasSearch ? ' cliente(s)' : ' cliente(s) con pagos');

            if (filtered.length === 0) {
                container.innerHTML = hasSearch 
                    ? '<div class="col-12 text-center text-muted py-5"><i class="bi bi-search me-2"></i>No se encontraron clientes con "' + searchVal + '"</div>'
                    : '<div class="col-12 text-center text-muted py-5"><i class="bi bi-search me-2"></i>No hay clientes con pagos registrados. Usa el buscador para a√±adir uno.</div>';
                return;
            }

            container.innerHTML = '';
            filtered.forEach(function(c) {
                var isPaid = c.status === 'paid';
                var isPending = c.status === 'pending';
                var borderColor = isPaid ? '#198754' : (isPending ? '#dc3545' : '#444');
                var nameColor = isPaid ? '#4ade80' : (isPending ? '#f87171' : '#f59e0b');

                var statusBadge = isPaid
                    ? '<span class="badge bg-success"><i class="bi bi-check-circle-fill me-1"></i>Pagado</span>'
                    : (isPending
                        ? '<span class="badge bg-danger"><i class="bi bi-clock-fill me-1"></i>Pendiente</span>'
                        : '<span class="badge bg-secondary">Sin datos</span>');

                var progressPct = (c.total_amount > 0) ? Math.min(100, (c.total_paid / c.total_amount * 100)).toFixed(1) : 0;

                var amountHtml = (c.total_amount > 0) ? (
                    '<div class="mt-2 pt-2 border-top border-secondary">' +
                    '<div class="d-flex justify-content-between small mb-1"><span class="text-muted">Total:</span><span class="text-warning fw-bold">' + formatEuro(c.total_amount) + '</span></div>' +
                    '<div class="d-flex justify-content-between small mb-1"><span class="text-muted">Pagado:</span><span class="text-success fw-bold">' + formatEuro(c.total_paid) + '</span></div>' +
                    '<div class="d-flex justify-content-between small mb-1"><span class="text-muted">Pendiente:</span><span class="' + (isPending ? 'text-danger fw-bold' : 'text-muted') + '">' + formatEuro(c.pending) + '</span></div>' +
                    '<div class="mt-2"><div class="progress" style="height:5px;background:#333;"><div class="progress-bar bg-success" style="width:' + progressPct + '%"></div></div></div>' +
                    '</div>'
                ) : '<div class="small text-muted mt-2"><i class="bi bi-exclamation-circle me-1"></i>Sin importe registrado</div>';

                var budgetHtml = c.budget_number ? '<div class="small text-muted mt-1"><i class="bi bi-file-earmark-text me-1"></i>Pres. ' + _esc(c.budget_number) + '</div>' : '';

                var col = document.createElement('div');
                col.className = 'col-12 col-md-6 col-lg-4';
                col.innerHTML =
                    '<div class="card text-white h-100" style="background:#161616;border:2px solid ' + borderColor + ';border-radius:12px;">' +
                        '<div class="card-body">' +
                            '<div class="d-flex justify-content-between align-items-start mb-2">' +
                                '<h6 class="card-title fw-bold mb-0" style="color:' + nameColor + ';">' +
                                    '<i class="bi bi-building me-1"></i>' + _esc(c.name) +
                                '</h6>' +
                                statusBadge +
                            '</div>' +
                            '<div class="small text-muted mb-1"><i class="bi bi-telephone-fill me-1 text-info"></i>' + _esc(c.phone) + '</div>' +
                            budgetHtml +
                            amountHtml +
                        '</div>' +
                        '<div class="card-footer bg-black border-0 pt-0">' +
                            '<button class="btn btn-sm btn-warning w-100 fw-bold open-payment-btn" data-pay-id="' + c.id + '">' +
                                '<i class="bi bi-cash-stack me-1"></i>Gestionar Pagos' +
                            '</button>' +
                        '</div>' +
                    '</div>';
                container.appendChild(col);
            });
        }

        // Buscar clientes sin pago para a√±adirlos al apartado de pagos
        function searchClientForPayment() {
            var q = document.getElementById('payAddClientSearch').value.trim();
            var listEl = document.getElementById('payAddClientList');
            if (q.length < 2) { listEl.style.display = 'none'; return; }
            
            fetch('/api/clients_search?q=' + encodeURIComponent(q))
                .then(r => r.json())
                .then(clients => {
                    listEl.innerHTML = '';
                    if (clients.length === 0) {
                        listEl.style.display = 'none';
                        return;
                    }
                    clients.forEach(function(c) {
                        var div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.innerHTML = '<i class="bi bi-building me-1 text-warning"></i><b>' + _esc(c.name) + '</b> <small class="text-muted">‚Äî ' + _esc(c.phone) + '</small>';
                        div.addEventListener('click', function() {
                            listEl.style.display = 'none';
                            document.getElementById('payAddClientSearch').value = '';
                            // Abrir directamente el modal de pagos para este cliente
                            openPaymentModal(c.id);
                            // A√±adir a la lista local para que aparezca en pagos
                            var existing = _allPaymentsData.find(function(p) { return p.id === c.id; });
                            if (!existing) {
                                _allPaymentsData.push({
                                    id: c.id, name: c.name, phone: c.phone,
                                    has_support: c.has_support, total_amount: 0,
                                    budget_number: '', total_paid: 0, pending: 0, status: 'pending'
                                });
                            }
                        });
                        listEl.appendChild(div);
                    });
                    listEl.style.display = 'block';
                });
        }
        
        document.addEventListener('click', function(e) {
            var list = document.getElementById('payAddClientList');
            if (list && !list.contains(e.target) && e.target.id !== 'payAddClientSearch') {
                list.style.display = 'none';
            }
        });

        function _esc(str) {
            if (!str) return '';
            return str.toString()
                .replace(/&/g,'&amp;')
                .replace(/</g,'&lt;')
                .replace(/>/g,'&gt;')
                .replace(/"/g,'&quot;');
        }

        function formatEuro(val) {
            return parseFloat(val || 0).toLocaleString('es-ES', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' ‚Ç¨';
        }

        function openPaymentModal(clientId) {
            document.getElementById('paymentClientId').value = clientId;
            document.getElementById('paymentClientName').innerText = 'Cargando...';
            // Reset
            document.getElementById('payBudgetNumber').value = '';
            document.getElementById('payTotalAmount').value = '';
            document.getElementById('payFirstPayment').value = '';
            document.getElementById('payTotal').innerText = '0,00 ‚Ç¨';
            document.getElementById('payPaid').innerText = '0,00 ‚Ç¨';
            document.getElementById('payPending').innerText = '0,00 ‚Ç¨';
            document.getElementById('payProgressBar').style.width = '0%';
            document.getElementById('paymentRecordsList').innerHTML = '<div class="text-muted text-center py-2 small"><div class="spinner-border spinner-border-sm me-2"></div>Cargando...</div>';
            hideAddRecordForm();
            var today = new Date().toISOString().split('T')[0];
            document.getElementById('newRecordDate').value = today;
            new bootstrap.Modal(document.getElementById('modalClientPayment')).show();
            loadPaymentDetail(clientId);
        }

        function loadPaymentDetail(clientId) {
            fetch('/api/payments/client/' + clientId)
                .then(function(res) {
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    return res.json();
                })
                .then(function(data) {
                    if (data.success) {
                        var d = data.data;
                        // Set client name from API (safe, no JS injection issues)
                        document.getElementById('paymentClientName').innerText = d.client_name || 'Cliente';
                        document.getElementById('payBudgetNumber').value = d.budget_number || '';
                        document.getElementById('payTotalAmount').value = d.total_amount || '';
                        document.getElementById('payFirstPayment').value = d.first_payment || '';
                        updatePaySummary(d.total_amount, d.total_paid, d.pending);
                        renderRecordsList(d.records);
                    } else {
                        document.getElementById('paymentRecordsList').innerHTML = '<div class="text-danger small">Error: ' + (data.msg || 'desconocido') + '</div>';
                    }
                })
                .catch(function(err) {
                    document.getElementById('paymentRecordsList').innerHTML = '<div class="text-danger small"><i class="bi bi-exclamation-triangle me-1"></i>Error al cargar: ' + err.message + '</div>';
                });
        }

        function updatePaySummary(total, paid, pending) {
            total = parseFloat(total) || 0;
            paid = parseFloat(paid) || 0;
            pending = parseFloat(pending) || 0;
            document.getElementById('payTotal').innerText = formatEuro(total);
            document.getElementById('payPaid').innerText = formatEuro(paid);
            document.getElementById('payPending').innerText = formatEuro(pending);
            var pct = total > 0 ? Math.min(100, (paid / total * 100)).toFixed(1) : 0;
            document.getElementById('payProgressBar').style.width = pct + '%';
        }

        function recalcPaymentLive() {
            // Recalcula en tiempo real mientras el usuario edita sin guardar
            var total = parseFloat(document.getElementById('payTotalAmount').value) || 0;
            var first = parseFloat(document.getElementById('payFirstPayment').value) || 0;
            var recordAmounts = [].slice.call(document.querySelectorAll('.pay-record-row')).map(function(el) {
                return parseFloat(el.dataset.amount) || 0;
            });
            var recordSum = recordAmounts.reduce(function(a,b){ return a+b; }, 0);
            var paid = first + recordSum;
            var pending = Math.max(0, total - paid);
            updatePaySummary(total, paid, pending);
        }

        function savePaymentData() {
            var clientId = document.getElementById('paymentClientId').value;
            var btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Guardando...';
            fetch('/api/payments/client/' + clientId, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    total_amount: parseFloat(document.getElementById('payTotalAmount').value) || 0,
                    budget_number: document.getElementById('payBudgetNumber').value.trim(),
                    first_payment: parseFloat(document.getElementById('payFirstPayment').value) || 0
                })
            })
            .then(function(res) { return res.json(); })
            .then(function(result) {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-floppy-fill me-1"></i>Guardar Datos';
                if (result.success) {
                    loadPaymentDetail(clientId);
                    loadPaymentsList(); // Refresca la lista principal
                    showPayToast('‚úì Datos guardados correctamente', 'success');
                } else {
                    alert('Error: ' + result.msg);
                }
            })
            .catch(function(err) {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-floppy-fill me-1"></i>Guardar Datos';
                alert('Error de conexi√≥n: ' + err.message);
            });
        }

        function renderRecordsList(records) {
            var container = document.getElementById('paymentRecordsList');
            if (!records || records.length === 0) {
                container.innerHTML = '<div class="text-muted text-center py-2 small"><i class="bi bi-inbox me-1"></i>Sin cobros parciales registrados</div>';
                return;
            }
            container.innerHTML = '';
            records.forEach(function(r) {
                var isPaid = r.is_paid === true || r.is_paid === 1;
                var bgColor = isPaid ? '#0d2b1a' : '#2b0d0d';
                var borderColor = isPaid ? '#198754' : '#dc3545';
                var amountColor = isPaid ? 'text-success' : 'text-danger';
                var toggleLabel = isPaid
                    ? '<i class="bi bi-check-circle-fill me-1"></i>Pagado'
                    : '<i class="bi bi-clock-fill me-1"></i>Pendiente';
                var toggleClass = isPaid ? 'btn-success' : 'btn-danger';

                var div = document.createElement('div');
                div.id = 'record-row-' + r.id;
                div.className = 'p-2 mb-2 rounded pay-record-row';
                div.dataset.amount = r.amount;
                div.style.cssText = 'background:' + bgColor + ';border:1px solid ' + borderColor + ';';
                div.innerHTML =
                    '<div class="d-flex justify-content-between align-items-start">' +
                        '<div>' +
                            '<span class="fw-bold ' + amountColor + ' me-2">' + formatEuro(r.amount) + '</span>' +
                            '<span class="badge bg-secondary small">' + r.date + '</span>' +
                            (r.notes ? '<div class="small text-muted mt-1"><i class="bi bi-chat-text me-1"></i>' + _esc(r.notes) + '</div>' : '') +
                        '</div>' +
                        '<div class="d-flex gap-2 align-items-center ms-2">' +
                            '<button class="btn btn-sm ' + toggleClass + ' fw-bold" style="font-size:0.75rem;min-width:110px;" onclick="toggleRecordPaid(' + r.id + ')" title="Cambiar estado de pago">' +
                                toggleLabel +
                            '</button>' +
                            '<button class="btn btn-sm btn-outline-danger flex-shrink-0" onclick="deleteRecord(' + r.id + ')" title="Eliminar cobro">' +
                                '<i class="bi bi-trash-fill"></i>' +
                            '</button>' +
                        '</div>' +
                    '</div>';
                container.appendChild(div);
            });
        }

        function toggleRecordPaid(recordId) {
            fetch('/api/payments/record/' + recordId + '/toggle_paid', {method: 'POST'})
            .then(function(res) { return res.json(); })
            .then(function(result) {
                if (result.success) {
                    var clientId = document.getElementById('paymentClientId').value;
                    loadPaymentDetail(clientId);
                    loadPaymentsList();
                    showPayToast(result.is_paid ? '‚úì Marcado como Pagado' : '‚úì Marcado como Pendiente', 'success');
                } else {
                    alert('Error: ' + result.msg);
                }
            })
            .catch(function(err) { alert('Error de conexi√≥n: ' + err.message); });
        }

        function showAddRecordForm() {
            document.getElementById('addRecordForm').style.display = 'block';
            document.getElementById('newRecordAmount').focus();
            // Reset switch state
            var sw = document.getElementById('newRecordIsPaid');
            var lbl = document.getElementById('newRecordIsPaidLabel');
            if (sw) sw.checked = false;
            if (lbl) { lbl.style.color = '#dc3545'; lbl.innerText = 'Pendiente'; }
        }
        function hideAddRecordForm() {
            var f = document.getElementById('addRecordForm');
            if (f) f.style.display = 'none';
            var amt = document.getElementById('newRecordAmount');
            var notes = document.getElementById('newRecordNotes');
            var isPaidSwitch = document.getElementById('newRecordIsPaid');
            var isPaidLabel = document.getElementById('newRecordIsPaidLabel');
            if (amt) amt.value = '';
            if (notes) notes.value = '';
            if (isPaidSwitch) { isPaidSwitch.checked = false; }
            if (isPaidLabel) { isPaidLabel.style.color = '#dc3545'; isPaidLabel.innerText = 'Pendiente'; }
        }

        function submitPaymentRecord() {
            var clientId = document.getElementById('paymentClientId').value;
            var amount = parseFloat(document.getElementById('newRecordAmount').value);
            var dateVal = document.getElementById('newRecordDate').value;
            var notes = document.getElementById('newRecordNotes').value.trim();
            var isPaid = document.getElementById('newRecordIsPaid').checked;
            if (!amount || amount <= 0) { alert('Introduce un importe v√°lido mayor que 0'); return; }
            if (!dateVal) { alert('Selecciona una fecha'); return; }
            fetch('/api/payments/record', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({client_id: parseInt(clientId), amount: amount, date: dateVal, notes: notes, is_paid: isPaid})
            })
            .then(function(res) { return res.json(); })
            .then(function(result) {
                if (result.success) {
                    hideAddRecordForm();
                    loadPaymentDetail(clientId);
                    loadPaymentsList();
                    showPayToast('‚úì Cobro registrado', 'success');
                } else {
                    alert('Error: ' + result.msg);
                }
            })
            .catch(function(err) { alert('Error de conexi√≥n: ' + err.message); });
        }

        function deleteRecord(recordId) {
            if (!confirm('¬øEliminar este cobro parcial?')) return;
            var clientId = document.getElementById('paymentClientId').value;
            fetch('/api/payments/record/' + recordId, {method: 'DELETE'})
            .then(function(res) { return res.json(); })
            .then(function(result) {
                if (result.success) {
                    loadPaymentDetail(clientId);
                    loadPaymentsList();
                    showPayToast('‚úì Cobro eliminado', 'success');
                } else {
                    alert('Error: ' + result.msg);
                }
            })
            .catch(function(err) { alert('Error de conexi√≥n: ' + err.message); });
        }

        function showPayToast(msg, type) {
            var old = document.getElementById('_payToast');
            if (old) old.remove();
            var t = document.createElement('div');
            t.id = '_payToast';
            t.style.cssText = 'position:fixed;bottom:24px;right:24px;z-index:9999;padding:10px 22px;border-radius:10px;font-weight:bold;color:white;transition:opacity 0.4s;box-shadow:0 4px 20px rgba(0,0,0,0.5);';
            t.style.background = type === 'success' ? '#198754' : '#dc3545';
            t.innerText = msg;
            document.body.appendChild(t);
            setTimeout(function() { t.style.opacity = '0'; setTimeout(function() { t.remove(); }, 450); }, 2500);
        }

        // Toggle visual label for is_paid switch
        document.addEventListener('DOMContentLoaded', function() {
            var sw = document.getElementById('newRecordIsPaid');
            if (sw) {
                sw.addEventListener('change', function() {
                    var lbl = document.getElementById('newRecordIsPaidLabel');
                    if (lbl) {
                        if (sw.checked) {
                            lbl.innerText = 'Pagado';
                            lbl.style.color = '#198754';
                        } else {
                            lbl.innerText = 'Pendiente';
                            lbl.style.color = '#dc3545';
                        }
                    }
                });
            }
        });

        // =====================================================================
        // INFORMES ‚Äî Filtrado por cliente y fecha (client-side)
        // =====================================================================
        function loadReports() {
            filterInformes();
        }

        function clearReportFilters() {
            var f = document.getElementById('reportFilterClient');
            var d1 = document.getElementById('reportFilterFrom');
            var d2 = document.getElementById('reportFilterTo');
            if(f) f.value = '';
            if(d1) d1.value = '';
            if(d2) d2.value = '';
            filterInformes();
        }

        function filterInformes() {
            var clientVal = (document.getElementById('reportFilterClient') || document.getElementById('informeFilterCliente'));
            var desdeEl = (document.getElementById('reportFilterFrom') || document.getElementById('informeFilterDesde'));
            var hastaEl = (document.getElementById('reportFilterTo') || document.getElementById('informeFilterHasta'));

            var clientFilter = clientVal ? clientVal.value.toLowerCase().trim() : '';
            var desdeFilter = desdeEl ? desdeEl.value : '';
            var hastaFilter = hastaEl ? hastaEl.value : '';

            var tbody = document.getElementById('reportsTbody') || document.getElementById('informesTbody');
            if (!tbody) return;

            var rows = tbody.querySelectorAll('tr');
            var visible = 0;

            rows.forEach(function(row) {
                var clientData = (row.getAttribute('data-client') || '').toLowerCase();
                var dateData = row.getAttribute('data-date') || '';

                var clientMatch = !clientFilter || clientData.indexOf(clientFilter) >= 0;
                var desdeMatch = !desdeFilter || dateData >= desdeFilter;
                var hastaMatch = !hastaFilter || dateData <= hastaFilter;

                if (clientMatch && desdeMatch && hastaMatch) {
                    row.style.display = '';
                    visible++;
                } else {
                    row.style.display = 'none';
                }
            });

            var countEl = document.getElementById('reportResultCount') || document.getElementById('informeFilterCount');
            if (countEl) {
                var total = rows.length;
                countEl.textContent = visible < total ? ('Mostrando ' + visible + ' de ' + total + ' informes') : (total + ' informes');
            }
        }

        // =====================================================================
        // PAGOS ‚Äî Clientes con pagos (paid/pending) visibles por defecto
        // =====================================================================
        // Override renderPaymentList so by default only paid/pending appear
        // When user types in search, all clients matching search are shown
        var _origRenderPaymentList = renderPaymentList;
        window._renderPaymentListOverridden = false;
        // Patch is already handled by modified renderPaymentList below, see _currentPayFilter usage
        // The button "Todos" now means "todos con pagos" and search shows "sin pagos" too

        // =====================================================================
        // T√âCNICOS ‚Äî Validar al menos uno seleccionado en modal de cita
        // =====================================================================
        // ‚úÖ NUEVA: Enviar formulario de cita por AJAX
        function submitScheduleForm() {
            // T√©cnico opcional ‚Äî sin selecci√≥n la tarea quedar√° "Sin asignar"
            const submitBtn = document.getElementById('scheduleSubmitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Agendando...';
            
            const formData = new FormData(document.getElementById('formScheduleAppointment'));
            
            fetch('/schedule_appointment', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                
                if (data.success) {
                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalScheduleAppointment'));
                    if (modal) modal.hide();
                    
                    // Mostrar mensaje de √©xito
                    alert('‚úÖ ' + data.msg);
                    
                    // ‚úÖ SINCRONIZACI√ìN: Refrescar calendarios autom√°ticamente
                    setTimeout(() => {
                        if (calendar) calendar.refetchEvents();
                        if (calendarGlobalInstance) calendarGlobalInstance.refetchEvents();
                    }, 300);
                    
                    // Limpiar formulario
                    document.getElementById('formScheduleAppointment').reset();
                    document.querySelectorAll('#formScheduleAppointment .tech-checkbox').forEach(cb => cb.checked = false);
                } else {
                    alert('‚ùå Error: ' + (data.msg || 'No se pudo agendar la cita'));
                }
            })
            .catch(err => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                console.error('Error:', err);
                alert('‚ùå Error de conexi√≥n. Por favor, intenta de nuevo.');
            });
            
            return false;
        }

        function validateTechSelection() {
            // T√©cnico opcional ‚Äî siempre v√°lido
            return true;
        }

        // =====================================================================
        // HORAS DE TRABAJO DEL CLIENTE ‚Äî Modal mensual
        // =====================================================================
        function openClientWorkHours(clientId, clientName) {
            document.getElementById('workHoursClientName').textContent = clientName || 'Cliente';
            document.getElementById('workHoursContent').innerHTML = '<div class="text-center text-muted py-3"><i class="bi bi-hourglass-split"></i> Cargando...</div>';
            new bootstrap.Modal(document.getElementById('modalClientWorkHours')).show();

            fetch('/api/client/' + clientId + '/monthly_hours')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (!data.success) throw new Error(data.msg || 'Error');
                    var d = data;
                    var entriesHtml = '';
                    if (d.entries && d.entries.length > 0) {
                        entriesHtml = '<div class="table-responsive mt-3"><table class="table table-dark table-sm table-bordered">' +
                            '<thead><tr><th>Fecha</th><th>T√©cnico</th><th>Servicio</th><th>Duraci√≥n</th></tr></thead><tbody>';
                        d.entries.forEach(function(e) {
                            entriesHtml += '<tr>' +
                                '<td>' + e.date + '</td>' +
                                '<td>' + _esc(e.tech) + '</td>' +
                                '<td>' + _esc(e.service) + '</td>' +
                                '<td><span style="font-family:monospace;color:#f37021;">' + e.duration + '</span></td>' +
                                '</tr>';
                        });
                        entriesHtml += '</tbody></table></div>';
                    } else {
                        entriesHtml = '<div class="alert alert-secondary">No hay visitas registradas este mes.</div>';
                    }

                    document.getElementById('workHoursContent').innerHTML =
                        '<div class="row g-3 mb-3">' +
                        '<div class="col-md-4"><div class="card bg-black border-warning text-center p-3">' +
                        '<h2 style="color:#f37021;">' + d.total_formatted + '</h2>' +
                        '<small class="text-muted">Total este mes (' + d.month + ')</small></div></div>' +
                        '<div class="col-md-4"><div class="card bg-black border-secondary text-center p-3">' +
                        '<h2 class="text-white">' + d.num_visits + '</h2>' +
                        '<small class="text-muted">Visitas realizadas</small></div></div>' +
                        '</div>' + entriesHtml;
                })
                .catch(function(err) {
                    document.getElementById('workHoursContent').innerHTML = '<div class="alert alert-danger">Error al cargar: ' + err.message + '</div>';
                });
        }
        // =====================================================================

        // ==================== FILTROS DE INFORMES ====================
        function loadReports() {
            var client = (document.getElementById('reportFilterClient') || {}).value || '';
            var dateFrom = (document.getElementById('reportFilterFrom') || {}).value || '';
            var dateTo = (document.getElementById('reportFilterTo') || {}).value || '';
            
            var params = new URLSearchParams();
            if (client) params.append('client', client);
            if (dateFrom) params.append('date_from', dateFrom);
            if (dateTo) params.append('date_to', dateTo);

            fetch('/api/reports?' + params.toString())
                .then(r => r.json())
                .then(function(data) {
                    if (!data.success) return;
                    var tbody = document.getElementById('reportsTbody');
                    if (!tbody) return;
                    
                    var countEl = document.getElementById('reportResultCount');
                    if (countEl) countEl.textContent = data.total + ' informes encontrados';

                    if (data.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4"><i class="bi bi-search me-2"></i>No hay informes que coincidan con los filtros</td></tr>';
                        return;
                    }

                    tbody.innerHTML = '';
                    data.data.forEach(function(r) {
                        var durationHtml = r.work_duration
                            ? '<span style="font-family:\'Courier New\',monospace;font-size:0.85rem;font-weight:700;color:#f37021;background:#1a0d00;border:1px solid #f37021;border-radius:6px;padding:3px 8px;letter-spacing:1px;white-space:nowrap;">' + r.work_duration + '</span>'
                            : '<span class="text-muted small">‚Äî</span>';
                        var attachHtml = r.has_attachments
                            ? '<button class="btn btn-sm btn-outline-info" onclick="showAttachmentsModal(' + r.id + ', \'' + r.client_name.replace(/'/g,"\'") + '\')"><i class="bi bi-paperclip"></i> ' + r.attachments_count + '</button>'
                            : '<span class="text-muted small">Sin archivos</span>';
                        var tr = document.createElement('tr');
                        tr.innerHTML = '<td>' + r.id + '</td><td>' + r.client_name + '</td><td>' + r.service_type + '</td><td>' + r.date + '</td><td>' + r.tech + '</td><td>' + durationHtml + '</td><td>' + attachHtml + '</td><td><a href="/print_report/' + r.id + '" target="_blank" class="btn btn-sm btn-outline-warning"><i class="bi bi-printer-fill"></i> Imprimir</a></td>';
                        tbody.appendChild(tr);
                    });
                })
                .catch(function(e) { console.error('Error loading reports:', e); });
        }

        function clearReportFilters() {
            var el;
            if ((el = document.getElementById('reportFilterClient'))) el.value = '';
            if ((el = document.getElementById('reportFilterFrom'))) el.value = '';
            if ((el = document.getElementById('reportFilterTo'))) el.value = '';
            var countEl = document.getElementById('reportResultCount');
            if (countEl) countEl.textContent = '';
            // Reset tbody to original template rows
            var tbody = document.getElementById('reportsTbody');
            if (tbody) {
                // Reload via API without filters
                loadReports();
            }
        }

        // ==================== HORAS TRABAJO CLIENTE ====================
        function showClientWorkHours(clientId, clientName) {
            document.getElementById('workHoursClientName').textContent = clientName;
            document.getElementById('workHoursContent').innerHTML = '<div class="text-center text-muted py-3"><div class="spinner-border spinner-border-sm me-2"></div>Cargando...</div>';
            new bootstrap.Modal(document.getElementById('modalClientWorkHours')).show();
            
            fetch('/api/client_work_hours/' + clientId)
                .then(r => r.json())
                .then(function(data) {
                    if (!data.success) {
                        document.getElementById('workHoursContent').innerHTML = '<div class="text-danger">Error al cargar datos</div>';
                        return;
                    }
                    var btn = document.getElementById('clientHours_' + clientId);
                    if (btn) btn.textContent = data.total_hours;

                    var html = '<div class="d-flex align-items-center gap-3 mb-3 p-3 rounded" style="background:#1a1a1a;">';
                    html += '<div class="text-center"><div style="font-size:2rem;font-weight:700;color:#f37021;font-family:\'Courier New\',monospace;">' + data.total_hours + '</div>';
                    html += '<small class="text-muted">Total ' + data.month + '</small></div>';
                    html += '<div class="flex-fill"><small class="text-muted">Servicios completados: <b class="text-white">' + data.tasks.length + '</b></small></div>';
                    html += '</div>';

                    if (data.tasks.length === 0) {
                        html += '<div class="text-center text-muted py-3"><i class="bi bi-calendar-x me-2"></i>Sin servicios este mes</div>';
                    } else {
                        html += '<table class="table table-dark table-sm table-hover"><thead><tr><th>Fecha</th><th>T√©cnico</th><th>Servicio</th><th>Duraci√≥n</th></tr></thead><tbody>';
                        data.tasks.forEach(function(t) {
                            html += '<tr><td>' + t.date + '</td><td>' + t.tech + '</td><td>' + t.service + '</td><td><span style="font-family:\'Courier New\',monospace;color:#f37021;">' + t.duration + '</span></td></tr>';
                        });
                        html += '</tbody></table>';
                    }
                    document.getElementById('workHoursContent').innerHTML = html;
                })
                .catch(function(e) {
                    document.getElementById('workHoursContent').innerHTML = '<div class="text-danger">Error de conexi√≥n</div>';
                });
        }

        // ==================== TAREAS SIN T√âCNICO ====================
        function submitUnassignedTaskForm() {
            const submitBtn = document.getElementById('unassignedSubmitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Creando...';
            
            const clientName = document.getElementById('unassignedClientInput').value.trim();
            const serviceTypeId = document.getElementById('unassignedServiceType').value;
            const description = document.getElementById('unassignedDescription').value.trim();
            
            if (!clientName || !serviceTypeId) {
                alert('‚ö†Ô∏è Por favor completa los campos requeridos');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                return false;
            }
            
            fetch('/create_task_unassigned', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    client_name: clientName,
                    service_type_id: parseInt(serviceTypeId),
                    description: description
                })
            })
            .then(res => res.json())
            .then(data => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalCreateUnassignedTask'));
                    if (modal) modal.hide();
                    alert('‚úÖ Tarea creada correctamente');
                    
                    // Cargar tareas sin t√©cnico
                    loadUnassignedTasks();
                    
                    // Limpiar formulario
                    document.getElementById('formCreateUnassignedTask').reset();
                } else {
                    alert('‚ùå Error: ' + (data.msg || 'No se pudo crear la tarea'));
                }
            })
            .catch(err => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                console.error('Error:', err);
                alert('‚ùå Error de conexi√≥n');
            });
            
            return false;
        }

        function loadUnassignedTasks() {
            fetch('/api/admin/unassigned_tasks')
            .then(res => res.json())
            .then(data => {
                const container = document.getElementById('unassignedTasksList');
                if (!data.success || data.data.length === 0) {
                    container.innerHTML = '<div class="text-muted text-center py-3"><i class="bi bi-check-circle me-2"></i>No hay tareas pendientes por asignar</div>';
                    return;
                }
                
                let html = '';
                data.data.forEach(task => {
                    html += `
                        <div class="card bg-dark border-danger mb-2">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <strong class="text-danger">${task.client_name}</strong>
                                    <small class="badge bg-danger">${task.service_type_name}</small>
                                </div>
                                <small class="text-muted d-block mb-2">${task.description || '(sin descripci√≥n)'}</small>
                                <button class="btn btn-sm btn-warning" onclick="openAssignTechModal(${task.id}, '${task.client_name}')">
                                    <i class="bi bi-person-plus me-1"></i> Asignar T√©cnico
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteTask(${task.id})">
                                    <i class="bi bi-trash me-1"></i> Eliminar
                                </button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            })
            .catch(err => {
                console.error('Error loading unassigned tasks:', err);
                document.getElementById('unassignedTasksList').innerHTML = '<div class="text-danger">Error al cargar tareas</div>';
            });
        }

        function openAssignTechModal(taskId, clientName) {
            // Crear modal din√°micamente para asignar t√©cnico
            let html = `
                <div class="modal fade" id="modalAssignTech" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content bg-dark text-white">
                            <div class="modal-header border-secondary">
                                <h5 class="modal-title">Asignar T√©cnico a ${clientName}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <form id="formAssignTech">
                                <div class="modal-body">
                                    <input type="hidden" id="assignTaskId" value="${taskId}">
                                    <label class="form-label">T√©cnico</label>
                                    <select id="assignTechId" class="form-select mb-2" required>
                                        <option value="">-- Seleccionar --</option>
                                        {% for emp in empleados %}
                                        <option value="{{ emp.id }}">{{ emp.username }}</option>
                                        {% endfor %}
                                    </select>
                                    <label class="form-label">Fecha</label>
                                    <input type="date" id="assignDate" class="form-control mb-2" required>
                                    <label class="form-label">Hora Inicio</label>
                                    <input type="time" id="assignStartTime" class="form-control mb-2" required>
                                    <label class="form-label">Hora Fin (opcional)</label>
                                    <input type="time" id="assignEndTime" class="form-control">
                                </div>
                                <div class="modal-footer border-secondary">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="button" class="btn btn-warning" onclick="submitAssignTech()">Asignar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal anterior si existe
            const oldModal = document.getElementById('modalAssignTech');
            if (oldModal) oldModal.remove();
            
            document.body.insertAdjacentHTML('beforeend', html);
            new bootstrap.Modal(document.getElementById('modalAssignTech')).show();
        }

        function submitAssignTech() {
            const taskId = document.getElementById('assignTaskId').value;
            const techId = document.getElementById('assignTechId').value;
            const date = document.getElementById('assignDate').value;
            const startTime = document.getElementById('assignStartTime').value;
            const endTime = document.getElementById('assignEndTime').value;
            
            if (!techId || !date || !startTime) {
                alert('‚ö†Ô∏è Complete los campos requeridos');
                return;
            }
            
            fetch(`/api/task/${taskId}/assign_tech`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    tech_id: parseInt(techId),
                    date: date,
                    start_time: startTime,
                    end_time: endTime
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalAssignTech'));
                    if (modal) modal.hide();
                    alert('‚úÖ T√©cnico asignado correctamente');
                    loadUnassignedTasks();
                    if (calendarGlobalInstance) calendarGlobalInstance.refetchEvents();
                } else {
                    alert('‚ùå Error: ' + (data.msg || 'No se pudo asignar'));
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert('‚ùå Error de conexi√≥n');
            });
        }

        function deleteTask(taskId) {
            if (!confirm('¬øEliminar esta tarea?')) return;
            
            fetch(`/api/task/${taskId}/delete`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Tarea eliminada');
                    loadUnassignedTasks();
                } else {
                    alert('‚ùå Error: ' + (data.msg || 'No se pudo eliminar'));
                }
            })
            .catch(err => console.error('Error:', err));
        }

        // ==================== VALIDAR T√âCNICOS EN MODAL CITA ====================

        // ‚úÖ NUEVA: Enviar formulario de cita por AJAX
        function submitScheduleForm() {
            // T√©cnico opcional ‚Äî sin selecci√≥n la tarea quedar√° "Sin asignar"
            const submitBtn = document.getElementById('scheduleSubmitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Agendando...';
            
            const formData = new FormData(document.getElementById('formScheduleAppointment'));
            
            fetch('/schedule_appointment', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                
                if (data.success) {
                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalScheduleAppointment'));
                    if (modal) modal.hide();
                    
                    // Mostrar mensaje de √©xito
                    alert('‚úÖ ' + data.msg);
                    
                    // ‚úÖ SINCRONIZACI√ìN: Refrescar calendarios autom√°ticamente
                    setTimeout(() => {
                        if (calendar) calendar.refetchEvents();
                        if (calendarGlobalInstance) calendarGlobalInstance.refetchEvents();
                    }, 300);
                    
                    // Limpiar formulario
                    document.getElementById('formScheduleAppointment').reset();
                    document.querySelectorAll('#formScheduleAppointment .tech-checkbox').forEach(cb => cb.checked = false);
                } else {
                    alert('‚ùå Error: ' + (data.msg || 'No se pudo agendar la cita'));
                }
            })
            .catch(err => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                console.error('Error:', err);
                alert('‚ùå Error de conexi√≥n. Por favor, intenta de nuevo.');
            });
            
            return false;
        }

        function validateTechSelection() {
            // T√©cnico opcional ‚Äî siempre v√°lido
            return true;
        }

    </script>

    <!-- ======================================================= -->
    <!-- Modal: Detalle de Pagos del Cliente                      -->
    <!-- ======================================================= -->
    <div class="modal fade" id="modalClientPayment" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-cash-coin me-2 text-warning"></i>
                        Pagos &mdash; <span id="paymentClientName">Cliente</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="paymentClientId">

                    <!-- Resumen visual -->
                    <div class="row g-2 mb-4">
                        <div class="col-4">
                            <div class="text-center p-3 rounded" style="background:#1a1a2e;border:1px solid #444;">
                                <div class="small text-muted mb-1">TOTAL TRABAJO</div>
                                <div class="fs-4 fw-bold text-warning" id="payTotal">0,00 ‚Ç¨</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center p-3 rounded" style="background:#0d2b1a;border:1px solid #198754;">
                                <div class="small text-muted mb-1">TOTAL PAGADO</div>
                                <div class="fs-4 fw-bold text-success" id="payPaid">0,00 ‚Ç¨</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center p-3 rounded" style="background:#2b0d0d;border:1px solid #dc3545;">
                                <div class="small text-muted mb-1">PENDIENTE</div>
                                <div class="fs-4 fw-bold text-danger" id="payPending">0,00 ‚Ç¨</div>
                            </div>
                        </div>
                    </div>

                    <!-- Barra de progreso -->
                    <div class="mb-4">
                        <div class="progress" style="height:8px;border-radius:4px;background:#333;">
                            <div class="progress-bar bg-success" id="payProgressBar" style="width:0%;transition:width 0.4s;"></div>
                        </div>
                    </div>

                    <!-- Datos del presupuesto -->
                    <div class="p-3 mb-3 rounded" style="background:#111;border:1px solid #333;">
                        <h6 class="text-warning fw-bold mb-3">
                            <i class="bi bi-file-earmark-text me-2"></i>Datos del Presupuesto
                        </h6>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <label class="form-label small">N&ordm; Presupuesto</label>
                                <input type="text" id="payBudgetNumber" class="form-control form-control-sm"
                                    placeholder="Ej: PRES-2024-001">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small">Importe Total (&euro;)</label>
                                <input type="number" id="payTotalAmount" class="form-control form-control-sm"
                                    placeholder="0.00" step="0.01" min="0" oninput="recalcPaymentLive()">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small">Primer Pago / Se&ntilde;al (&euro;)</label>
                                <input type="number" id="payFirstPayment" class="form-control form-control-sm"
                                    placeholder="0.00" step="0.01" min="0" oninput="recalcPaymentLive()">
                            </div>
                        </div>
                        <div class="mt-3 text-end">
                            <button class="btn btn-warning btn-sm fw-bold" onclick="savePaymentData()">
                                <i class="bi bi-floppy-fill me-1"></i>Guardar Datos
                            </button>
                        </div>
                    </div>

                    <!-- Historial de cobros -->
                    <div class="p-3 rounded" style="background:#111;border:1px solid #333;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-warning fw-bold mb-0">
                                <i class="bi bi-list-check me-2"></i>Historial de Cobros Parciales
                            </h6>
                            <button class="btn btn-sm btn-outline-success fw-bold" onclick="showAddRecordForm()">
                                <i class="bi bi-plus-circle-fill me-1"></i>A&ntilde;adir Cobro
                            </button>
                        </div>

                        <!-- Formulario nuevo cobro (inline) -->
                        <div id="addRecordForm" style="display:none;" class="p-3 mb-3 rounded border border-secondary" style="background:#1a1a1a;">
                            <h6 class="text-info small fw-bold mb-2">Nuevo Cobro Parcial</h6>
                            <div class="row g-2">
                                <div class="col-md-3">
                                    <label class="form-label small">Importe (&euro;) *</label>
                                    <input type="number" id="newRecordAmount" class="form-control form-control-sm"
                                        placeholder="0.00" step="0.01" min="0.01">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small">Fecha *</label>
                                    <input type="date" id="newRecordDate" class="form-control form-control-sm">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">Observaciones</label>
                                    <input type="text" id="newRecordNotes" class="form-control form-control-sm"
                                        placeholder="Opcional...">
                                </div>
                                <div class="col-md-2 d-flex flex-column justify-content-end">
                                    <label class="form-label small d-block">Estado</label>
                                    <div class="form-check form-switch mt-1">
                                        <input class="form-check-input" type="checkbox" id="newRecordIsPaid" role="switch">
                                        <label class="form-check-label small" for="newRecordIsPaid" id="newRecordIsPaidLabel" style="color:#dc3545;font-weight:bold;">Pendiente</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2 d-flex gap-2">
                                <button class="btn btn-success btn-sm fw-bold" onclick="submitPaymentRecord()">
                                    <i class="bi bi-check-lg me-1"></i>Guardar Cobro
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="hideAddRecordForm()">Cancelar</button>
                            </div>
                        </div>

                        <!-- Lista de cobros registrados -->
                        <div id="paymentRecordsList">
                            <div class="text-muted text-center py-2 small">
                                <i class="bi bi-inbox me-1"></i>Sin cobros registrados
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>


</body>

</html>
<script>
// ‚úÖ NUEVO: Funciones para Asistencia Remota
document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('remoteClientSearch');
    const clientsList = document.getElementById('remoteClientsList');
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const val = this.value;
            if (!val || val.length < 2) {
                clientsList.innerHTML = '';
                clientsList.style.display = 'none';
                return;
            }
            
            fetch(`/api/clients_search?q=${encodeURIComponent(val)}`)
                .then(res => res.json())
                .then(data => {
                    clientsList.innerHTML = '';
                    if (data.length > 0) {
                        clientsList.style.display = 'block';
                        data.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'suggestion-item';
                            div.innerText = item.name;
                            div.onclick = function() {
                                selectRemoteClient(item.id, item.name);
                            };
                            clientsList.appendChild(div);
                        });
                    }
                });
        });
        
        document.addEventListener('click', (e) => {
            if (e.target !== searchInput) {
                clientsList.style.display = 'none';
            }
        });
    }
});

function selectRemoteClient(clientId, clientName) {
    document.getElementById('remoteSelectedClientId').value = clientId;
    document.getElementById('remoteSelectedClientName').value = clientName;
    document.getElementById('remoteClientSearch').value = clientName;
    document.getElementById('remoteClientsList').style.display = 'none';
    
    fetch(`/api/client/${clientId}/support_info`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const client = data.data;
                document.getElementById('remoteClientName').textContent = client.name;
                document.getElementById('remoteClientPhone').textContent = client.phone || '-';
                document.getElementById('remoteClientEmail').textContent = client.email || '-';
                document.getElementById('remoteClientAddress').textContent = client.address || '-';
                
                const supportBadge = document.getElementById('remoteSupportBadge');
                const supportBadgeNo = document.getElementById('remoteSupportBadgeNo');
                
                if (client.has_support) {
                    supportBadge.style.display = 'inline-block';
                    supportBadgeNo.style.display = 'none';
                } else {
                    supportBadge.style.display = 'none';
                    supportBadgeNo.style.display = 'inline-block';
                }
                
                document.getElementById('remoteClientCard').style.display = 'block';
            }
        })
        .catch(err => console.log('Error:', err));
}

function submitRemoteAssistance() {
    const clientId = document.getElementById('remoteSelectedClientId').value;
    const clientName = document.getElementById('remoteSelectedClientName').value;
    const description = document.getElementById('remoteDescription').value.trim();
    
    if (!clientId || !clientName) {
        alert('‚ö†Ô∏è Por favor selecciona un cliente');
        return;
    }
    
    const submitBtn = document.getElementById('remoteSubmitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Creando...';
    
    fetch('/api/remote_assistance', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({client_id: clientId, client_name: clientName, description: description})
    })
    .then(res => res.json())
    .then(data => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-plus-lg me-1"></i>Crear Asistencia';
        
        if (data.success) {
            alert('‚úÖ Asistencia remota creada');
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalRemoteAssistance'));
            if (modal) modal.hide();
            document.getElementById('remoteClientSearch').value = '';
            document.getElementById('remoteDescription').value = '';
            document.getElementById('remoteClientCard').style.display = 'none';
            if (window.calendarGlobalInstance) window.calendarGlobalInstance.refetchEvents();
        } else {
            alert('‚ùå Error: ' + (data.msg || 'No se pudo crear'));
        }
    })
    .catch(err => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-plus-lg me-1"></i>Crear Asistencia';
        alert('‚ùå Error de conexi√≥n');
    });
}
</script>